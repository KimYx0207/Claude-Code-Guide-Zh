# Module 8.2: ä¼ä¸šå®‰å…¨ä¸åˆè§„æŒ‡å—

**ç‰ˆæœ¬**: 1.0
**ä½œè€…**: è€é‡‘
**æœ€åæ›´æ–°**: 2025-12-12
**å­—æ•°**: 11,000+ å­—
**éš¾åº¦**: â­â­â­â­â­ (é«˜çº§)


## ğŸ“– è¯¾ç¨‹å¯¼èˆª

**ä¸Šä¸€èŠ‚**ï¼š[Module 8.1: ä¼ä¸šå›¢é˜Ÿåä½œæœ€ä½³å®è·µ](./ä¼ä¸šå›¢é˜Ÿåä½œæœ€ä½³å®è·µ.md)
**å½“å‰èŠ‚**ï¼š**Module 8.2: ä¼ä¸šå®‰å…¨ä¸åˆè§„æŒ‡å—**
**ä¸‹ä¸€èŠ‚**ï¼šModule 9.1: ä¼ä¸šæ¡ˆä¾‹æ·±åº¦åˆ†æ


**æœ¬æ¨¡å—è·¯å¾„**: `08-ä¼ä¸šå®æˆ˜/ä¼ä¸šå®‰å…¨ä¸åˆè§„æŒ‡å—.md`


## ğŸ¯ å­¦ä¹ ç›®æ ‡
è‰¹ï¼Œå®‰å…¨é—®é¢˜æ˜¯ä¼ä¸šçš„ç”Ÿå‘½çº¿ï¼è€é‡‘æˆ‘è§è¿‡å¤ªå¤šSBæŠŠAPI Keyæäº¤åˆ°GitHubï¼Œç„¶åä¸€ä¸ªæœˆè¢«åˆ·$10,000çš„æ¡ˆä¾‹ï¼

å®Œæˆæœ¬èŠ‚åï¼Œä½ å°†èƒ½å¤Ÿï¼š

1ã€âœ… å»ºç«‹ **ä¼ä¸šçº§API Keyç®¡ç†ä½“ç³»**ï¼Œé˜²æ­¢å¯†é’¥æ³„éœ²å’Œæ»¥ç”¨
2ã€âœ… å®ç° **æ•æ„Ÿæ•°æ®å…¨é“¾è·¯ä¿æŠ¤**ï¼Œä»ä»£ç åˆ°æ—¥å¿—åˆ°æ•°æ®åº“
3ã€âœ… æ»¡è¶³ **GDPR/HIPAA/SOC2ç­‰åˆè§„è¦æ±‚**ï¼Œé€šè¿‡ä¼ä¸šå®¡è®¡
4ã€âœ… éƒ¨ç½² **è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æç³»ç»Ÿ**ï¼ŒæŒç»­æ£€æµ‹ä»£ç å’Œé…ç½®æ¼æ´
5ã€âœ… åˆ¶å®š **APIæ³„éœ²åº”æ€¥å“åº”æµç¨‹**ï¼Œæœ€å°åŒ–å®‰å…¨äº‹æ•…å½±å“
6ã€âœ… æ‰§è¡Œ **20æ¡ä¼ä¸šå®‰å…¨æœ€ä½³å®è·µ**ï¼Œå»ºç«‹çºµæ·±é˜²å¾¡ä½“ç³»


## ğŸ“Š æ–‡æ¡£ä»·å€¼

**ç»´åº¦**ï¼š**ä¸¥è‚ƒæ€§**
**è¯´æ˜**ï¼šä¼ä¸šå®‰å…¨ç”Ÿæ­»æ”¸å…³ï¼Œç»ä¸èƒ½é©¬è™


**ç»´åº¦**ï¼š**å®Œæ•´æ€§**
**è¯´æ˜**ï¼šè¦†ç›–APIå¯†é’¥ã€æ•æ„Ÿæ•°æ®ã€åˆè§„ã€å®¡è®¡å…¨é“¾è·¯


**ç»´åº¦**ï¼š**å¯æ“ä½œæ€§**
**è¯´æ˜**ï¼šæä¾›10+å®Œæ•´è„šæœ¬å’Œæ£€æŸ¥æ¸…å•


**ç»´åº¦**ï¼š**åˆè§„æ€§**
**è¯´æ˜**ï¼šæ»¡è¶³GDPRã€HIPAAã€SOC2è¦æ±‚


## Part 1: API Keyå®‰å…¨ç®¡ç†ï¼ˆ2,500å­—ï¼‰
### 1.1 API Keyæ³„éœ²çš„ç¾éš¾åæœ
**è€é‡‘è§è¿‡çš„çœŸå®æ¡ˆä¾‹**ï¼š


**äº‹æ•…**ï¼šAPI Keyæäº¤åˆ°GitHub
**åæœ**ï¼šè¢«æ‰«æå™¨å‘ç°ï¼Œç«‹åˆ»è¢«ç›—åˆ·
**æŸå¤±**ï¼š**$15,000**


**äº‹æ•…**ï¼šç¡¬ç¼–ç åœ¨å‰ç«¯ä»£ç 
**åæœ**ï¼šæš´éœ²ç»™æ‰€æœ‰ç”¨æˆ·
**æŸå¤±**ï¼š**æ— é™é¢åº¦æ»¥ç”¨**


**äº‹æ•…**ï¼šæ˜æ–‡å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶
**åæœ**ï¼šæœåŠ¡å™¨è¢«å…¥ä¾µåæ³„éœ²
**æŸå¤±**ï¼š**$8,000**


**äº‹æ•…**ï¼šå…±äº«ç»™ç¦»èŒå‘˜å·¥
**åæœ**ï¼šå‰å‘˜å·¥æ¶æ„ä½¿ç”¨
**æŸå¤±**ï¼š**æ³•å¾‹è¯‰è®¼**


**äº‹æ•…**ï¼šæœªè®¾ç½®ä½¿ç”¨é™åˆ¶
**åæœ**ï¼šè¢«DDoSæ”»å‡»åˆ·é‡
**æŸå¤±**ï¼š**$25,000**


**è‰¹ï¼Œè¿™äº›éƒ½æ˜¯è¡€æ·‹æ·‹çš„æ•™è®­ï¼æ¯ä¸€ä¸ªéƒ½èƒ½è®©å…¬å¸ç ´äº§ï¼**


### 1.2 ä¼ä¸šçº§å¯†é’¥ç®¡ç†æ¶æ„
#### 1.2.1 å¯†é’¥åˆ†çº§ç®¡ç†
```
å¯†é’¥å±‚çº§ä½“ç³»ï¼š

Production Keys (ç”Ÿäº§ç¯å¢ƒ)
â”œâ”€â”€ Master Key (ä¸»å¯†é’¥)          # æœ€é«˜æƒé™ï¼Œä»…CEO/CTOæŒæœ‰
â”‚   â”œâ”€â”€ ç”¨é€”ï¼šå¯†é’¥è½®æ¢ã€ç´§æ€¥æ¢å¤
â”‚   â””â”€â”€ è®¿é—®ï¼š2FA + ç¡¬ä»¶å¯†é’¥
â”œâ”€â”€ Service Keys (æœåŠ¡å¯†é’¥)      # å„æœåŠ¡ç‹¬ç«‹å¯†é’¥
â”‚   â”œâ”€â”€ API Gateway Key          # é™åˆ¶ï¼š10,000 RPM
â”‚   â”œâ”€â”€ Backend Service Key      # é™åˆ¶ï¼š5,000 RPM
â”‚   â””â”€â”€ Batch Job Key            # é™åˆ¶ï¼š100 RPM
â””â”€â”€ Developer Keys (å¼€å‘å¯†é’¥)    # å¼€å‘/æµ‹è¯•ç¯å¢ƒ
    â”œâ”€â”€ Dev Environment          # é™åˆ¶ï¼š100 RPM
    â””â”€â”€ Test Environment         # é™åˆ¶ï¼š50 RPM

Staging Keys (é¢„å‘å¸ƒç¯å¢ƒ)
â””â”€â”€ ç‹¬ç«‹å¯†é’¥ï¼Œä¸ç”Ÿäº§å®Œå…¨éš”ç¦»

Development Keys (å¼€å‘ç¯å¢ƒ)
â””â”€â”€ å›¢é˜Ÿå…±äº«ï¼Œæ¯å‘¨è½®æ¢
```

**ğŸ“¸ æˆªå›¾ä½ç½®ï¼šä¼ä¸šå¯†é’¥å±‚çº§æ¶æ„å›¾**


#### 1.2.2 å¯†é’¥å­˜å‚¨æ–¹æ¡ˆ
**âŒ ç»å¯¹ç¦æ­¢çš„åšæ³•**ï¼š
```python
# âŒ ç¡¬ç¼–ç ï¼ˆæ‰¾æ­»ï¼‰
ANTHROPIC_API_KEY = "sk-ant-api03-XXXXXXXX"

# âŒ æäº¤åˆ°Gitï¼ˆè‡ªæ€ï¼‰
# .envæ–‡ä»¶æœªåŠ å…¥.gitignore

# âŒ æ˜æ–‡é…ç½®æ–‡ä»¶ï¼ˆé€æ­»ï¼‰
api_key: "sk-ant-api03-XXXXXXXX"

# âŒ å‰ç«¯ä»£ç ï¼ˆç¾¤ä½“è‡ªæ€ï¼‰
const API_KEY = "sk-ant-api03-XXXXXXXX";
```

**âœ… æ­£ç¡®çš„ä¼ä¸šçº§åšæ³•**ï¼š
```python
# âœ… æ–¹æ¡ˆ1ï¼šç¯å¢ƒå˜é‡ + Secrets Manager
import os
import boto3

def get_api_key() -> str:
    """ä»AWS Secrets Managerè·å–API Key"""
    session = boto3.session.Session()
    client = session.client(
        service_name='secretsmanager',
        region_name='us-east-1'
    )

    try:
        response = client.get_secret_value(
            SecretId='prod/anthropic/api-key'
        )
        return response['SecretString']
    except Exception as e:
        # é™çº§åˆ°ç¯å¢ƒå˜é‡
        return os.getenv("ANTHROPIC_API_KEY")

# âœ… æ–¹æ¡ˆ2ï¼šHashiCorp Vault
import hvac

def get_api_key_from_vault() -> str:
    """ä»Vaultè·å–API Key"""
    client = hvac.Client(url='https://vault.example.com:8200')

    # ä½¿ç”¨AppRoleè®¤è¯
    client.auth.approle.login(
        role_id=os.getenv("VAULT_ROLE_ID"),
        secret_id=os.getenv("VAULT_SECRET_ID")
    )

    # è¯»å–å¯†é’¥
    secret = client.secrets.kv.v2.read_secret_version(
        path='anthropic/api-key',
        mount_point='secret'
    )

    return secret['data']['data']['key']

# âœ… æ–¹æ¡ˆ3ï¼šAzure Key Vault
from azure.identity import DefaultAzureCredential
from azure.keyvault.secrets import SecretClient

def get_api_key_from_azure() -> str:
    """ä»Azure Key Vaultè·å–API Key"""
    credential = DefaultAzureCredential()
    client = SecretClient(
        vault_url="https://myvault.vault.azure.net/",
        credential=credential
    )

    secret = client.get_secret("anthropic-api-key")
    return secret.value
```

**ä¸‰å¤§æ–¹æ¡ˆå¯¹æ¯”**ï¼š


**æ–¹æ¡ˆ**ï¼š**AWS Secrets Manager**
**ä¼˜ç‚¹**ï¼šä¸AWSç”Ÿæ€æ·±åº¦é›†æˆ
**ç¼ºç‚¹**ï¼šä»…é™AWS
**é€‚ç”¨åœºæ™¯**ï¼šAWSç”¨æˆ·


**æ–¹æ¡ˆ**ï¼š**HashiCorp Vault**
**ä¼˜ç‚¹**ï¼šè·¨å¹³å°ã€åŠŸèƒ½å¼ºå¤§
**ç¼ºç‚¹**ï¼šéœ€è¦é¢å¤–ç»´æŠ¤
**é€‚ç”¨åœºæ™¯**ï¼šå¤šäº‘ç¯å¢ƒ


**æ–¹æ¡ˆ**ï¼š**Azure Key Vault**
**ä¼˜ç‚¹**ï¼šä¸Azureé›†æˆè‰¯å¥½
**ç¼ºç‚¹**ï¼šä»…é™Azure
**é€‚ç”¨åœºæ™¯**ï¼šAzureç”¨æˆ·


### 1.3 å¯†é’¥è½®æ¢è‡ªåŠ¨åŒ–
**å®Œæ•´çš„å¯†é’¥è½®æ¢è„šæœ¬**ï¼š
```bash
#!/bin/bash
# rotate-api-keys.sh - è‡ªåŠ¨è½®æ¢APIå¯†é’¥
# ä½œè€…: è€é‡‘
# ç‰ˆæœ¬: 2.0

set -e

# ==================== é…ç½® ====================
VAULT_ADDR="https://vault.example.com:8200"
SLACK_WEBHOOK_URL="${SLACK_WEBHOOK_URL}"
KEY_ROTATION_INTERVAL_DAYS=90  # 90å¤©è½®æ¢ä¸€æ¬¡

# ==================== é¢œè‰²å®šä¹‰ ====================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# ==================== æ—¥å¿—å‡½æ•° ====================
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
    logger -t "key-rotation" "INFO: $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
    logger -t "key-rotation" "WARN: $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
    logger -t "key-rotation" "ERROR: $1"
}

# ==================== Slacké€šçŸ¥ ====================
send_slack_notification() {
    local message="$1"
    local level="$2"  # info, warn, error

    local color="#36a64f"  # ç»¿è‰²
    if [[ "$level" == "warn" ]]; then
        color="#FFA500"  # æ©™è‰²
    elif [[ "$level" == "error" ]]; then
        color="#ff0000"  # çº¢è‰²
    fi

    curl -X POST "$SLACK_WEBHOOK_URL" \
        -H 'Content-Type: application/json' \
        -d "{
            \"attachments\": [{
                \"color\": \"$color\",
                \"title\": \"APIå¯†é’¥è½®æ¢é€šçŸ¥\",
                \"text\": \"$message\",
                \"footer\": \"Security Bot\",
                \"ts\": $(date +%s)
            }]
        }"
}

# ==================== æ£€æŸ¥å¯†é’¥è¿‡æœŸ ====================
check_key_expiry() {
    log_info "æ£€æŸ¥å¯†é’¥æ˜¯å¦éœ€è¦è½®æ¢..."

    # ä»Vaultè¯»å–å¯†é’¥å…ƒæ•°æ®
    local metadata=$(vault kv metadata get secret/anthropic/api-key -format=json)

    # æå–åˆ›å»ºæ—¶é—´
    local created_time=$(echo "$metadata" | jq -r '.data.created_time')
    local created_timestamp=$(date -d "$created_time" +%s)
    local current_timestamp=$(date +%s)

    # è®¡ç®—å¤©æ•°å·®
    local days_old=$(( (current_timestamp - created_timestamp) / 86400 ))

    log_info "å½“å‰å¯†é’¥å·²ä½¿ç”¨ $days_old å¤©"

    if [[ $days_old -ge $KEY_ROTATION_INTERVAL_DAYS ]]; then
        log_warn "å¯†é’¥å·²è¿‡æœŸï¼Œéœ€è¦è½®æ¢"
        return 0
    else
        log_info "å¯†é’¥æœªè¿‡æœŸï¼Œæ— éœ€è½®æ¢"
        return 1
    fi
}

# ==================== ç”Ÿæˆæ–°å¯†é’¥ ====================
generate_new_key() {
    log_info "ç”Ÿæˆæ–°çš„APIå¯†é’¥..."

    # è°ƒç”¨Anthropic APIåˆ›å»ºæ–°å¯†é’¥
    # æ³¨æ„ï¼šå®é™…å®ç°éœ€è¦ä½¿ç”¨Anthropicçš„å¯†é’¥ç®¡ç†API
    # è¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿé€»è¾‘

    local new_key="sk-ant-api03-$(openssl rand -hex 24)"

    log_info "æ–°å¯†é’¥å·²ç”Ÿæˆ: ${new_key:0:20}..."
    echo "$new_key"
}

# ==================== å­˜å‚¨æ–°å¯†é’¥ ====================
store_new_key() {
    local new_key="$1"

    log_info "å­˜å‚¨æ–°å¯†é’¥åˆ°Vault..."

    # å¤‡ä»½æ—§å¯†é’¥
    local old_key=$(vault kv get -field=key secret/anthropic/api-key)

    vault kv put secret/anthropic/api-key-backup \
        key="$old_key" \
        rotated_at="$(date -Iseconds)"

    # å­˜å‚¨æ–°å¯†é’¥
    vault kv put secret/anthropic/api-key \
        key="$new_key" \
        created_at="$(date -Iseconds)" \
        rotated_by="$USER"

    log_info "æ–°å¯†é’¥å·²å­˜å‚¨åˆ°Vault"
}

# ==================== æ›´æ–°æ‰€æœ‰æœåŠ¡ ====================
update_services() {
    log_info "æ›´æ–°æ‰€æœ‰ä½¿ç”¨è¯¥å¯†é’¥çš„æœåŠ¡..."

    # æœåŠ¡åˆ—è¡¨
    local services=(
        "api-gateway"
        "backend-service"
        "batch-jobs"
    )

    for service in "${services[@]}"; do
        log_info "æ›´æ–°æœåŠ¡: $service"

        # è§¦å‘Kubernetesæ»šåŠ¨æ›´æ–°
        kubectl rollout restart deployment/$service -n production

        # ç­‰å¾…éƒ¨ç½²å®Œæˆ
        kubectl rollout status deployment/$service -n production --timeout=5m

        if [[ $? -eq 0 ]]; then
            log_info "æœåŠ¡ $service æ›´æ–°æˆåŠŸ"
        else
            log_error "æœåŠ¡ $service æ›´æ–°å¤±è´¥"
            return 1
        fi
    done

    log_info "æ‰€æœ‰æœåŠ¡æ›´æ–°å®Œæˆ"
}

# ==================== éªŒè¯æ–°å¯†é’¥ ====================
verify_new_key() {
    log_info "éªŒè¯æ–°å¯†é’¥æ˜¯å¦å·¥ä½œ..."

    local new_key=$(vault kv get -field=key secret/anthropic/api-key)

    # æµ‹è¯•APIè°ƒç”¨
    local response=$(curl -s -w "\n%{http_code}" https://api.anthropic.com/v1/messages \
        -H "x-api-key: $new_key" \
        -H "anthropic-version: 2023-06-01" \
        -H "content-type: application/json" \
        -d '{
            "model": "claude-sonnet-4.5-20250929",
            "max_tokens": 10,
            "messages": [{"role": "user", "content": "test"}]
        }')

    local http_code=$(echo "$response" | tail -n1)

    if [[ "$http_code" == "200" ]]; then
        log_info "æ–°å¯†é’¥éªŒè¯æˆåŠŸ"
        return 0
    else
        log_error "æ–°å¯†é’¥éªŒè¯å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $http_code"
        return 1
    fi
}

# ==================== æ’¤é”€æ—§å¯†é’¥ ====================
revoke_old_key() {
    log_info "æ’¤é”€æ—§å¯†é’¥..."

    local old_key=$(vault kv get -field=key secret/anthropic/api-key-backup)

    # è°ƒç”¨Anthropic APIæ’¤é”€æ—§å¯†é’¥
    # æ³¨æ„ï¼šå®é™…å®ç°éœ€è¦ä½¿ç”¨Anthropicçš„å¯†é’¥ç®¡ç†API

    log_info "æ—§å¯†é’¥å·²æ’¤é”€: ${old_key:0:20}..."

    # ä»Vaultåˆ é™¤å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
    # vault kv delete secret/anthropic/api-key-backup
}

# ==================== å›æ»šåˆ°æ—§å¯†é’¥ ====================
rollback_to_old_key() {
    log_error "æ£€æµ‹åˆ°æ–°å¯†é’¥æœ‰é—®é¢˜ï¼Œå¼€å§‹å›æ»š..."

    local old_key=$(vault kv get -field=key secret/anthropic/api-key-backup)

    # æ¢å¤æ—§å¯†é’¥
    vault kv put secret/anthropic/api-key \
        key="$old_key" \
        restored_at="$(date -Iseconds)"

    # é‡æ–°éƒ¨ç½²æœåŠ¡
    update_services

    log_warn "å·²å›æ»šåˆ°æ—§å¯†é’¥"

    send_slack_notification "âš ï¸ å¯†é’¥è½®æ¢å¤±è´¥ï¼Œå·²å›æ»šåˆ°æ—§å¯†é’¥" "error"
}

# ==================== ä¸»å‡½æ•° ====================
main() {
    log_info "å¼€å§‹APIå¯†é’¥è½®æ¢æµç¨‹..."

    # 1. æ£€æŸ¥æ˜¯å¦éœ€è¦è½®æ¢
    if ! check_key_expiry; then
        log_info "æ— éœ€è½®æ¢ï¼Œé€€å‡º"
        exit 0
    fi

    # 2. ç”Ÿæˆæ–°å¯†é’¥
    local new_key=$(generate_new_key)

    # 3. å­˜å‚¨æ–°å¯†é’¥
    store_new_key "$new_key"

    # 4. æ›´æ–°æ‰€æœ‰æœåŠ¡
    if ! update_services; then
        rollback_to_old_key
        exit 1
    fi

    # 5. ç­‰å¾…5åˆ†é’Ÿï¼Œè§‚å¯ŸæœåŠ¡çŠ¶æ€
    log_info "ç­‰å¾…5åˆ†é’Ÿï¼Œè§‚å¯ŸæœåŠ¡è¿è¡ŒçŠ¶å†µ..."
    sleep 300

    # 6. éªŒè¯æ–°å¯†é’¥
    if ! verify_new_key; then
        rollback_to_old_key
        exit 1
    fi

    # 7. æ’¤é”€æ—§å¯†é’¥
    revoke_old_key

    # 8. å‘é€æˆåŠŸé€šçŸ¥
    send_slack_notification "âœ… APIå¯†é’¥è½®æ¢æˆåŠŸå®Œæˆ" "info"

    log_info "å¯†é’¥è½®æ¢æµç¨‹æˆåŠŸå®Œæˆï¼"
}

# æ‰§è¡Œä¸»å‡½æ•°
main
```

**è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯90å¤©æ‰§è¡Œä¸€æ¬¡ï¼‰**ï¼š
```bash
# æ·»åŠ åˆ°crontab
0 2 1 */3 * /opt/scripts/rotate-api-keys.sh
```

**ğŸ“¸ æˆªå›¾ä½ç½®ï¼šå¯†é’¥è½®æ¢è„šæœ¬æ‰§è¡Œæ—¥å¿—**


### 1.4 API Keyè®¿é—®å®¡è®¡
**å®Œæ•´çš„å®¡è®¡æ—¥å¿—è®°å½•è„šæœ¬**ï¼š
```python
#!/usr/bin/env python3
"""
API Keyè®¿é—®å®¡è®¡ç³»ç»Ÿ
è®°å½•æ‰€æœ‰API Keyçš„ä½¿ç”¨æƒ…å†µï¼Œæ£€æµ‹å¼‚å¸¸è®¿é—®
"""

import os
import json
import sqlite3
from datetime import datetime, timedelta
from typing import Dict, List, Optional
import hashlib
import requests

# ==================== é…ç½® ====================
DB_PATH = "/var/log/api-key-audit.db"
SLACK_WEBHOOK_URL = os.getenv("SLACK_WEBHOOK_URL")

# å¼‚å¸¸æ£€æµ‹é˜ˆå€¼
RATE_LIMIT_PER_MINUTE = 100
UNUSUAL_LOCATION_THRESHOLD = 1000  # è·ç¦»ï¼ˆå…¬é‡Œï¼‰
UNUSUAL_TIME_START = 22  # 22:00
UNUSUAL_TIME_END = 6     # 06:00

# ==================== æ•°æ®åº“åˆå§‹åŒ– ====================
def init_database():
    """åˆå§‹åŒ–å®¡è®¡æ•°æ®åº“"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS api_access_log (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        timestamp DATETIME NOT NULL,
        key_hash TEXT NOT NULL,
        user_id TEXT,
        service_name TEXT NOT NULL,
        endpoint TEXT NOT NULL,
        ip_address TEXT NOT NULL,
        user_agent TEXT,
        latitude REAL,
        longitude REAL,
        response_status INTEGER,
        tokens_used INTEGER,
        cost REAL,
        is_anomaly BOOLEAN DEFAULT 0,
        anomaly_reason TEXT
    )
    """)

    # ç´¢å¼•
    cursor.execute("""
    CREATE INDEX IF NOT EXISTS idx_timestamp ON api_access_log(timestamp)
    """)

    cursor.execute("""
    CREATE INDEX IF NOT EXISTS idx_key_hash ON api_access_log(key_hash)
    """)

    cursor.execute("""
    CREATE INDEX IF NOT EXISTS idx_anomaly ON api_access_log(is_anomaly)
    """)

    conn.commit()
    conn.close()

# ==================== API Keyå“ˆå¸Œ ====================
def hash_api_key(api_key: str) -> str:
    """å¯¹API Keyè¿›è¡Œå“ˆå¸Œï¼Œé¿å…æ˜æ–‡å­˜å‚¨"""
    return hashlib.sha256(api_key.encode()).hexdigest()[:16]

# ==================== è®°å½•è®¿é—®æ—¥å¿— ====================
def log_api_access(
    api_key: str,
    user_id: Optional[str],
    service_name: str,
    endpoint: str,
    ip_address: str,
    user_agent: Optional[str],
    response_status: int,
    tokens_used: int
):
    """è®°å½•ä¸€æ¬¡APIè®¿é—®"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # API Keyå“ˆå¸Œ
    key_hash = hash_api_key(api_key)

    # è®¡ç®—æˆæœ¬
    cost = tokens_used * 0.003 / 1000  # ç®€åŒ–è®¡ç®—

    # åœ°ç†ä½ç½®ï¼ˆé€šè¿‡IPæŸ¥è¯¢ï¼‰
    geo_data = get_geolocation(ip_address)

    # å¼‚å¸¸æ£€æµ‹
    is_anomaly, anomaly_reason = detect_anomaly(
        key_hash, ip_address, geo_data, datetime.now()
    )

    cursor.execute("""
    INSERT INTO api_access_log (
        timestamp, key_hash, user_id, service_name, endpoint,
        ip_address, user_agent, latitude, longitude,
        response_status, tokens_used, cost,
        is_anomaly, anomaly_reason
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    """, (
        datetime.now(), key_hash, user_id, service_name, endpoint,
        ip_address, user_agent,
        geo_data['latitude'], geo_data['longitude'],
        response_status, tokens_used, cost,
        is_anomaly, anomaly_reason
    ))

    conn.commit()
    conn.close()

    # å¦‚æœæ£€æµ‹åˆ°å¼‚å¸¸ï¼Œç«‹å³é€šçŸ¥
    if is_anomaly:
        send_anomaly_alert(key_hash, anomaly_reason, ip_address)

# ==================== åœ°ç†ä½ç½®æŸ¥è¯¢ ====================
def get_geolocation(ip_address: str) -> Dict:
    """é€šè¿‡IPåœ°å€æŸ¥è¯¢åœ°ç†ä½ç½®"""
    try:
        response = requests.get(f"https://ipapi.co/{ip_address}/json/")
        data = response.json()
        return {
            'latitude': data.get('latitude', 0),
            'longitude': data.get('longitude', 0),
            'city': data.get('city', 'Unknown'),
            'country': data.get('country_name', 'Unknown')
        }
    except Exception as e:
        return {
            'latitude': 0,
            'longitude': 0,
            'city': 'Unknown',
            'country': 'Unknown'
        }

# ==================== å¼‚å¸¸æ£€æµ‹ ====================
def detect_anomaly(
    key_hash: str,
    ip_address: str,
    geo_data: Dict,
    current_time: datetime
) -> tuple[bool, Optional[str]]:
    """æ£€æµ‹APIè®¿é—®æ˜¯å¦å¼‚å¸¸"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # æ£€æµ‹1ï¼šé€Ÿç‡å¼‚å¸¸ï¼ˆ1åˆ†é’Ÿå†…è°ƒç”¨æ¬¡æ•°ï¼‰
    one_minute_ago = current_time - timedelta(minutes=1)
    cursor.execute("""
    SELECT COUNT(*) FROM api_access_log
    WHERE key_hash = ? AND timestamp >= ?
    """, (key_hash, one_minute_ago))

    recent_calls = cursor.fetchone()[0]

    if recent_calls > RATE_LIMIT_PER_MINUTE:
        conn.close()
        return True, f"é€Ÿç‡å¼‚å¸¸ï¼š1åˆ†é’Ÿå†…è°ƒç”¨{recent_calls}æ¬¡"

    # æ£€æµ‹2ï¼šåœ°ç†ä½ç½®å¼‚å¸¸ï¼ˆä¸å†å²ä½ç½®å·®å¼‚å¤§ï¼‰
    cursor.execute("""
    SELECT latitude, longitude FROM api_access_log
    WHERE key_hash = ? AND timestamp >= ?
    ORDER BY timestamp DESC LIMIT 10
    """, (key_hash, current_time - timedelta(days=7)))

    recent_locations = cursor.fetchall()

    if recent_locations:
        for lat, lon in recent_locations:
            distance = calculate_distance(
                geo_data['latitude'], geo_data['longitude'],
                lat, lon
            )
            if distance > UNUSUAL_LOCATION_THRESHOLD:
                conn.close()
                return True, f"åœ°ç†ä½ç½®å¼‚å¸¸ï¼šè·ç¦»ä¸Šæ¬¡{distance:.0f}å…¬é‡Œ"

    # æ£€æµ‹3ï¼šæ—¶é—´å¼‚å¸¸ï¼ˆéå·¥ä½œæ—¶é—´ï¼‰
    hour = current_time.hour
    if hour >= UNUSUAL_TIME_START or hour < UNUSUAL_TIME_END:
        # æ£€æŸ¥æ˜¯å¦æœ‰å·¥ä½œæ—¶é—´çš„å†å²è®°å½•
        cursor.execute("""
        SELECT COUNT(*) FROM api_access_log
        WHERE key_hash = ?
          AND (CAST(strftime('%H', timestamp) AS INTEGER) < ?
               AND CAST(strftime('%H', timestamp) AS INTEGER) >= ?)
        """, (key_hash, UNUSUAL_TIME_START, UNUSUAL_TIME_END))

        work_hours_count = cursor.fetchone()[0]

        if work_hours_count > 100:  # å†å²ä¸Šæœ‰å¤§é‡å·¥ä½œæ—¶é—´è®°å½•
            conn.close()
            return True, f"æ—¶é—´å¼‚å¸¸ï¼šéå·¥ä½œæ—¶é—´è®¿é—®ï¼ˆ{hour}:00ï¼‰"

    conn.close()
    return False, None

# ==================== è®¡ç®—åœ°ç†è·ç¦» ====================
def calculate_distance(lat1: float, lon1: float, lat2: float, lon2: float) -> float:
    """è®¡ç®—ä¸¤ä¸ªåœ°ç†åæ ‡ä¹‹é—´çš„è·ç¦»ï¼ˆå…¬é‡Œï¼‰"""
    from math import radians, sin, cos, sqrt, atan2

    R = 6371  # åœ°çƒåŠå¾„ï¼ˆå…¬é‡Œï¼‰

    lat1, lon1, lat2, lon2 = map(radians, [lat1, lon1, lat2, lon2])

    dlat = lat2 - lat1
    dlon = lon2 - lon1

    a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
    c = 2 * atan2(sqrt(a), sqrt(1-a))

    return R * c

# ==================== å‘é€å¼‚å¸¸å‘Šè­¦ ====================
def send_anomaly_alert(key_hash: str, reason: str, ip_address: str):
    """å‘é€å¼‚å¸¸è®¿é—®å‘Šè­¦åˆ°Slack"""
    if not SLACK_WEBHOOK_URL:
        return

    message = {
        "text": "ğŸš¨ APIè®¿é—®å¼‚å¸¸æ£€æµ‹",
        "blocks": [
            {
                "type": "header",
                "text": {
                    "type": "plain_text",
                    "text": "ğŸš¨ APIè®¿é—®å¼‚å¸¸æ£€æµ‹"
                }
            },
            {
                "type": "section",
                "fields": [
                    {
                        "type": "mrkdwn",
                        "text": f"*å¯†é’¥å“ˆå¸Œ:*\n`{key_hash}`"
                    },
                    {
                        "type": "mrkdwn",
                        "text": f"*IPåœ°å€:*\n`{ip_address}`"
                    },
                    {
                        "type": "mrkdwn",
                        "text": f"*å¼‚å¸¸åŸå› :*\n{reason}"
                    },
                    {
                        "type": "mrkdwn",
                        "text": f"*æ—¶é—´:*\n{datetime.now().isoformat()}"
                    }
                ]
            },
            {
                "type": "actions",
                "elements": [
                    {
                        "type": "button",
                        "text": {
                            "type": "plain_text",
                            "text": "æŸ¥çœ‹è¯¦æƒ…"
                        },
                        "url": f"https://dashboard.example.com/audit/{key_hash}"
                    },
                    {
                        "type": "button",
                        "text": {
                            "type": "plain_text",
                            "text": "æ’¤é”€å¯†é’¥"
                        },
                        "style": "danger",
                        "url": f"https://dashboard.example.com/revoke/{key_hash}"
                    }
                ]
            }
        ]
    }

    requests.post(SLACK_WEBHOOK_URL, json=message)

# ==================== ç”Ÿæˆå®¡è®¡æŠ¥å‘Š ====================
def generate_audit_report(days: int = 7) -> Dict:
    """ç”ŸæˆAPIè®¿é—®å®¡è®¡æŠ¥å‘Š"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    start_date = datetime.now() - timedelta(days=days)

    # æ€»ä½“ç»Ÿè®¡
    cursor.execute("""
    SELECT
        COUNT(*) as total_accesses,
        COUNT(DISTINCT key_hash) as unique_keys,
        COUNT(DISTINCT ip_address) as unique_ips,
        SUM(tokens_used) as total_tokens,
        SUM(cost) as total_cost,
        SUM(CASE WHEN is_anomaly = 1 THEN 1 ELSE 0 END) as anomalies
    FROM api_access_log
    WHERE timestamp >= ?
    """, (start_date,))

    overall = cursor.fetchone()

    # æŒ‰å¯†é’¥ç»Ÿè®¡
    cursor.execute("""
    SELECT
        key_hash,
        COUNT(*) as accesses,
        SUM(tokens_used) as tokens,
        SUM(cost) as cost,
        SUM(CASE WHEN is_anomaly = 1 THEN 1 ELSE 0 END) as anomalies
    FROM api_access_log
    WHERE timestamp >= ?
    GROUP BY key_hash
    ORDER BY cost DESC
    LIMIT 10
    """, (start_date,))

    top_keys = cursor.fetchall()

    # å¼‚å¸¸è®¿é—®è¯¦æƒ…
    cursor.execute("""
    SELECT
        timestamp,
        key_hash,
        ip_address,
        anomaly_reason
    FROM api_access_log
    WHERE is_anomaly = 1 AND timestamp >= ?
    ORDER BY timestamp DESC
    LIMIT 20
    """, (start_date,))

    anomalies = cursor.fetchall()

    conn.close()

    return {
        "period_days": days,
        "overall": {
            "total_accesses": overall[0],
            "unique_keys": overall[1],
            "unique_ips": overall[2],
            "total_tokens": overall[3],
            "total_cost": round(overall[4], 2),
            "anomalies": overall[5]
        },
        "top_keys": [
            {
                "key_hash": row[0],
                "accesses": row[1],
                "tokens": row[2],
                "cost": round(row[3], 2),
                "anomalies": row[4]
            }
            for row in top_keys
        ],
        "recent_anomalies": [
            {
                "timestamp": row[0],
                "key_hash": row[1],
                "ip_address": row[2],
                "reason": row[3]
            }
            for row in anomalies
        ]
    }

# ==================== ä¸»å‡½æ•° ====================
def main():
    init_database()

    # ç¤ºä¾‹ï¼šæ¨¡æ‹ŸAPIè®¿é—®
    log_api_access(
        api_key="sk-ant-api03-test-key",
        user_id="user123",
        service_name="api-gateway",
        endpoint="/v1/messages",
        ip_address="203.0.113.42",
        user_agent="curl/7.68.0",
        response_status=200,
        tokens_used=1500
    )

    # ç”ŸæˆæŠ¥å‘Š
    report = generate_audit_report(days=7)
    print(json.dumps(report, indent=2))

if __name__ == "__main__":
    main()
```

**ğŸ“¸ æˆªå›¾ä½ç½®ï¼šAPIè®¿é—®å®¡è®¡æŠ¥å‘Šç•Œé¢**


## Part 2: æ•æ„Ÿæ•°æ®ä¿æŠ¤ï¼ˆ2,000å­—ï¼‰
### 2.1 Git Secretsæ‰«æ
**å®Œæ•´çš„Git Secretsæ‰«æè„šæœ¬**ï¼š
```bash
#!/bin/bash
# scan-git-secrets.sh - æ‰«æGitä»“åº“ä¸­çš„æ•æ„Ÿä¿¡æ¯
# ä½œè€…: è€é‡‘
# ç‰ˆæœ¬: 2.0

set -e

# ==================== é…ç½® ====================
REPORT_FILE="git-secrets-report.json"

# æ•æ„Ÿä¿¡æ¯æ­£åˆ™è¡¨è¾¾å¼
declare -A PATTERNS=(
    ["anthropic_api_key"]="sk-ant-api[0-9]{2}-[a-zA-Z0-9_-]{95,}"
    ["aws_access_key"]="AKIA[0-9A-Z]{16}"
    ["aws_secret_key"]="[0-9a-zA-Z/+=]{40}"
    ["openai_api_key"]="sk-[a-zA-Z0-9]{48}"
    ["github_token"]="ghp_[a-zA-Z0-9]{36}"
    ["private_key"]="-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----"
    ["password"]="password\\s*[=:]\\s*['\"][^'\"]{8,}['\"]"
    ["secret"]="secret\\s*[=:]\\s*['\"][^'\"]{8,}['\"]"
)

# ==================== é¢œè‰²å®šä¹‰ ====================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# ==================== æ—¥å¿—å‡½æ•° ====================
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ==================== æ‰«æGitå†å² ====================
scan_git_history() {
    log_info "æ‰«æGitå†å²ä¸­çš„æ•æ„Ÿä¿¡æ¯..."

    local findings=()

    # è·å–æ‰€æœ‰æäº¤
    local commits=$(git log --all --format="%H" --no-merges)

    while IFS= read -r commit; do
        # è·å–æäº¤diff
        local diff=$(git show "$commit")

        # æ£€æŸ¥æ¯ä¸ªæ¨¡å¼
        for secret_type in "${!PATTERNS[@]}"; do
            local pattern="${PATTERNS[$secret_type]}"

            if echo "$diff" | grep -qiE "$pattern"; then
                local file=$(git show --name-only "$commit" | head -n 5)

                log_error "å‘ç° $secret_type: commit $commit"

                findings+=("{
                    \"type\": \"$secret_type\",
                    \"commit\": \"$commit\",
                    \"file\": \"$file\"
                }")
            fi
        done
    done <<< "$commits"

    # ç”ŸæˆJSONæŠ¥å‘Š
    echo "{\"findings\": [$(IFS=,; echo "${findings[*]}")], \"total\": ${#findings[@]}}" > "$REPORT_FILE"

    if [[ ${#findings[@]} -gt 0 ]]; then
        log_error "å‘ç° ${#findings[@]} å¤„æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼"
        return 1
    else
        log_info "æœªå‘ç°æ•æ„Ÿä¿¡æ¯æ³„éœ²"
        return 0
    fi
}

# ==================== æ‰«æå½“å‰æ–‡ä»¶ ====================
scan_current_files() {
    log_info "æ‰«æå½“å‰æ–‡ä»¶ä¸­çš„æ•æ„Ÿä¿¡æ¯..."

    local findings=()

    # è·å–æ‰€æœ‰è·Ÿè¸ªçš„æ–‡ä»¶
    local files=$(git ls-files)

    while IFS= read -r file; do
        # è·³è¿‡äºŒè¿›åˆ¶æ–‡ä»¶
        if file "$file" | grep -q "text"; then
            local content=$(cat "$file")

            # æ£€æŸ¥æ¯ä¸ªæ¨¡å¼
            for secret_type in "${!PATTERNS[@]}"; do
                local pattern="${PATTERNS[$secret_type]}"

                if echo "$content" | grep -qiE "$pattern"; then
                    local line_num=$(grep -niE "$pattern" "$file" | head -n 1 | cut -d: -f1)

                    log_error "å‘ç° $secret_type: $file:$line_num"

                    findings+=("{
                        \"type\": \"$secret_type\",
                        \"file\": \"$file\",
                        \"line\": $line_num
                    }")
                fi
            done
        fi
    done <<< "$files"

    if [[ ${#findings[@]} -gt 0 ]]; then
        log_error "å‘ç° ${#findings[@]} å¤„æ•æ„Ÿä¿¡æ¯ï¼"
        return 1
    else
        log_info "æœªå‘ç°æ•æ„Ÿä¿¡æ¯"
        return 0
    fi
}

# ==================== æ¸…ç†Gitå†å² ====================
clean_git_history() {
    local file_pattern="$1"

    log_warn "æ¸…ç†Gitå†å²ä¸­çš„æ•æ„Ÿæ–‡ä»¶: $file_pattern"

    # ä½¿ç”¨git-filter-repoæ¸…ç†å†å²
    if command -v git-filter-repo &> /dev/null; then
        git-filter-repo --path "$file_pattern" --invert-paths --force
        log_info "å·²ä½¿ç”¨git-filter-repoæ¸…ç†"
    elif command -v bfg &> /dev/null; then
        bfg --delete-files "$file_pattern"
        log_info "å·²ä½¿ç”¨BFG Repo-Cleaneræ¸…ç†"
    else
        log_error "æœªå®‰è£…git-filter-repoæˆ–BFGï¼Œè¯·æ‰‹åŠ¨æ¸…ç†"
        return 1
    fi
}

# ==================== ä¸»å‡½æ•° ====================
main() {
    log_info "å¼€å§‹Git Secretsæ‰«æ..."

    local exit_code=0

    # æ‰«æå½“å‰æ–‡ä»¶
    if ! scan_current_files; then
        exit_code=1
    fi

    # æ‰«æGitå†å²
    if ! scan_git_history; then
        exit_code=1
    fi

    # ç”ŸæˆæŠ¥å‘Š
    log_info "æ‰«ææŠ¥å‘Šå·²ä¿å­˜åˆ°: $REPORT_FILE"

    if [[ $exit_code -ne 0 ]]; then
        log_error "æ‰«æå‘ç°é—®é¢˜ï¼Œè¯·ç«‹å³å¤„ç†ï¼"
    fi

    exit $exit_code
}

main
```

**é›†æˆåˆ°CI/CD**ï¼š
```yaml
# .github/workflows/security-scan.yml
name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:

jobs:
  git-secrets-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # å®Œæ•´å†å²

      - name: è¿è¡ŒGit Secretsæ‰«æ
        run: ./scripts/scan-git-secrets.sh

      - name: ä¸Šä¼ æ‰«ææŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: git-secrets-report
          path: git-secrets-report.json
```


### 2.2 æ—¥å¿—è„±æ•
**å®Œæ•´çš„æ—¥å¿—è„±æ•åº“**ï¼š
```python
#!/usr/bin/env python3
"""
æ—¥å¿—è„±æ•å·¥å…·
è‡ªåŠ¨æ£€æµ‹å¹¶è„±æ•æ—¥å¿—ä¸­çš„æ•æ„Ÿä¿¡æ¯
"""

import re
import logging
from typing import List, Dict, Callable

# ==================== æ•æ„Ÿä¿¡æ¯æ¨¡å¼ ====================
SENSITIVE_PATTERNS = {
    'api_key': re.compile(r'(sk-ant-api[0-9]{2}-)[a-zA-Z0-9_-]{95,}'),
    'email': re.compile(r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'),
    'phone': re.compile(r'\b\d{3}[-.\s]?\d{3}[-.\s]?\d{4}\b'),
    'credit_card': re.compile(r'\b\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}\b'),
    'ssn': re.compile(r'\b\d{3}-\d{2}-\d{4}\b'),
    'ip_address': re.compile(r'\b(?:\d{1,3}\.){3}\d{1,3}\b'),
    'password': re.compile(r'(password["\']?\s*[:=]\s*["\']?)([^"\']+)(["\']?)'),
}

# ==================== è„±æ•ç­–ç•¥ ====================
def mask_full(match: re.Match) -> str:
    """å®Œå…¨è„±æ•"""
    return '*' * len(match.group(0))

def mask_partial(match: re.Match, keep_first: int = 4, keep_last: int = 4) -> str:
    """éƒ¨åˆ†è„±æ•ï¼Œä¿ç•™å‰åå­—ç¬¦"""
    text = match.group(0)
    if len(text) <= keep_first + keep_last:
        return '*' * len(text)

    return text[:keep_first] + '*' * (len(text) - keep_first - keep_last) + text[-keep_last:]

def mask_api_key(match: re.Match) -> str:
    """API Keyè„±æ•ï¼Œä¿ç•™å‰ç¼€"""
    prefix = match.group(1)  # sk-ant-api03-
    return prefix + '*' * 95

def mask_email(match: re.Match) -> str:
    """é‚®ç®±è„±æ•ï¼Œä¿ç•™åŸŸå"""
    email = match.group(0)
    local, domain = email.split('@')
    if len(local) <= 2:
        masked_local = '*' * len(local)
    else:
        masked_local = local[0] + '*' * (len(local) - 2) + local[-1]
    return f"{masked_local}@{domain}"

def mask_password(match: re.Match) -> str:
    """å¯†ç è„±æ•"""
    return match.group(1) + '***REDACTED***' + match.group(3)

# ==================== è„±æ•æ˜ å°„ ====================
MASKING_STRATEGIES: Dict[str, Callable] = {
    'api_key': mask_api_key,
    'email': mask_email,
    'phone': lambda m: m.group(0)[:3] + '-***-' + m.group(0)[-4:],
    'credit_card': lambda m: '**** **** **** ' + m.group(0)[-4:],
    'ssn': lambda m: '***-**-' + m.group(0)[-4:],
    'ip_address': lambda m: '.'.join(m.group(0).split('.')[:2]) + '.***.**',
    'password': mask_password,
}

# ==================== æ—¥å¿—è„±æ•ç±» ====================
class SensitiveDataFilter(logging.Filter):
    """æ—¥å¿—è„±æ•è¿‡æ»¤å™¨"""

    def filter(self, record: logging.LogRecord) -> bool:
        """è¿‡æ»¤å¹¶è„±æ•æ—¥å¿—è®°å½•"""
        # è„±æ•æ¶ˆæ¯
        record.msg = self.mask_sensitive_data(str(record.msg))

        # è„±æ•å‚æ•°
        if record.args:
            record.args = tuple(
                self.mask_sensitive_data(str(arg)) for arg in record.args
            )

        return True

    @staticmethod
    def mask_sensitive_data(text: str) -> str:
        """è„±æ•æ–‡æœ¬ä¸­çš„æ•æ„Ÿä¿¡æ¯"""
        for pattern_name, pattern in SENSITIVE_PATTERNS.items():
            strategy = MASKING_STRATEGIES.get(pattern_name, mask_full)
            text = pattern.sub(strategy, text)

        return text

# ==================== é…ç½®æ—¥å¿— ====================
def setup_secure_logging():
    """é…ç½®å¸¦è„±æ•åŠŸèƒ½çš„æ—¥å¿—ç³»ç»Ÿ"""
    logger = logging.getLogger()
    logger.setLevel(logging.INFO)

    # æ§åˆ¶å°å¤„ç†å™¨
    console_handler = logging.StreamHandler()
    console_handler.setLevel(logging.INFO)

    # æ–‡ä»¶å¤„ç†å™¨
    file_handler = logging.FileHandler('app.log')
    file_handler.setLevel(logging.INFO)

    # æ ¼å¼åŒ–
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    console_handler.setFormatter(formatter)
    file_handler.setFormatter(formatter)

    # æ·»åŠ è„±æ•è¿‡æ»¤å™¨
    sensitive_filter = SensitiveDataFilter()
    console_handler.addFilter(sensitive_filter)
    file_handler.addFilter(sensitive_filter)

    # æ·»åŠ å¤„ç†å™¨
    logger.addHandler(console_handler)
    logger.addHandler(file_handler)

# ==================== æµ‹è¯•ç¤ºä¾‹ ====================
def main():
    setup_secure_logging()
    logger = logging.getLogger(__name__)

    # æµ‹è¯•å„ç§æ•æ„Ÿä¿¡æ¯
    logger.info("API Key: sk-ant-api03-AbCdEfGhIjKlMnOpQrStUvWxYz0123456789AbCdEfGhIjKlMnOpQrStUvWxYz01234567890123456789AbCdEf")
    logger.info("Email: john.doe@example.com")
    logger.info("Phone: 123-456-7890")
    logger.info("Credit Card: 1234-5678-9012-3456")
    logger.info("SSN: 123-45-6789")
    logger.info("IP: 192.168.1.100")
    logger.info("password='super_secret_123'")

if __name__ == "__main__":
    main()
```

**é›†æˆåˆ°åº”ç”¨**ï¼š
```python
# app.py
from sensitive_data_filter import setup_secure_logging

# åœ¨åº”ç”¨å¯åŠ¨æ—¶é…ç½®
setup_secure_logging()

# æ­£å¸¸ä½¿ç”¨logging
import logging
logger = logging.getLogger(__name__)

logger.info(f"User login with API Key: {api_key}")  # è‡ªåŠ¨è„±æ•
```


## Part 3: ä¼ä¸šåˆè§„è¦æ±‚ï¼ˆ1,500å­—ï¼‰
### 3.1 GDPRåˆè§„
**GDPRï¼ˆé€šç”¨æ•°æ®ä¿æŠ¤æ¡ä¾‹ï¼‰æ ¸å¿ƒè¦æ±‚**ï¼š


**è¦æ±‚**ï¼š**æ•°æ®æœ€å°åŒ–**
**è¯´æ˜**ï¼šä»…æ”¶é›†å¿…è¦æ•°æ®
**Claude Codeå®ç°**ï¼šé™åˆ¶æ—¥å¿—è®°å½•çš„ä¸ªäººä¿¡æ¯


**è¦æ±‚**ï¼š**è®¿é—®æƒ**
**è¯´æ˜**ï¼šç”¨æˆ·å¯è¯·æ±‚è®¿é—®æ•°æ®
**Claude Codeå®ç°**ï¼šæä¾›æ•°æ®å¯¼å‡ºAPI


**è¦æ±‚**ï¼š**åˆ é™¤æƒ**
**è¯´æ˜**ï¼šç”¨æˆ·å¯è¯·æ±‚åˆ é™¤æ•°æ®
**Claude Codeå®ç°**ï¼šå®ç°æ•°æ®åˆ é™¤æµç¨‹


**è¦æ±‚**ï¼š**æ•°æ®å¯ç§»æ¤æ€§**
**è¯´æ˜**ï¼šæ•°æ®å¯å¯¼å‡º
**Claude Codeå®ç°**ï¼šJSON/CSVæ ¼å¼å¯¼å‡º


**è¦æ±‚**ï¼š**è¿è§„é€šçŸ¥**
**è¯´æ˜**ï¼š72å°æ—¶å†…é€šçŸ¥
**Claude Codeå®ç°**ï¼šè‡ªåŠ¨åŒ–äº‹æ•…å“åº”æµç¨‹


**è¦æ±‚**ï¼š**æ•°æ®ä¿æŠ¤å®˜**
**è¯´æ˜**ï¼šæŒ‡å®šDPO
**Claude Codeå®ç°**ï¼šå®‰å…¨å›¢é˜Ÿè´Ÿè´£äºº


**GDPRåˆè§„æ£€æŸ¥è„šæœ¬**ï¼š
```python
#!/usr/bin/env python3
"""
GDPRåˆè§„æ£€æŸ¥å·¥å…·
"""

import json
from typing import List, Dict

class GDPRComplianceChecker:
    """GDPRåˆè§„æ£€æŸ¥å™¨"""

    def __init__(self):
        self.checks = []

    def check_data_minimization(self) -> bool:
        """æ£€æŸ¥æ•°æ®æœ€å°åŒ–"""
        # æ£€æŸ¥æ—¥å¿—é…ç½®
        with open('.claude/config.json') as f:
            config = json.load(f)

        # æ£€æŸ¥æ˜¯å¦è®°å½•äº†ä¸å¿…è¦çš„ä¸ªäººä¿¡æ¯
        sensitive_fields = ['email', 'phone', 'address']

        for field in sensitive_fields:
            if field in config.get('logging', {}).get('fields', []):
                self.checks.append({
                    'requirement': 'Data Minimization',
                    'status': 'FAIL',
                    'reason': f'Logging sensitive field: {field}'
                })
                return False

        self.checks.append({
            'requirement': 'Data Minimization',
            'status': 'PASS'
        })
        return True

    def check_right_to_access(self) -> bool:
        """æ£€æŸ¥è®¿é—®æƒ"""
        # æ£€æŸ¥æ˜¯å¦æä¾›æ•°æ®å¯¼å‡ºAPI
        # ç®€åŒ–ç¤ºä¾‹
        self.checks.append({
            'requirement': 'Right to Access',
            'status': 'PASS'
        })
        return True

    def check_right_to_erasure(self) -> bool:
        """æ£€æŸ¥åˆ é™¤æƒ"""
        # æ£€æŸ¥æ˜¯å¦å®ç°æ•°æ®åˆ é™¤æµç¨‹
        self.checks.append({
            'requirement': 'Right to Erasure',
            'status': 'PASS'
        })
        return True

    def generate_report(self) -> Dict:
        """ç”Ÿæˆåˆè§„æŠ¥å‘Š"""
        passed = sum(1 for c in self.checks if c['status'] == 'PASS')
        total = len(self.checks)

        return {
            'total_checks': total,
            'passed': passed,
            'failed': total - passed,
            'compliance_rate': f"{passed/total*100:.1f}%",
            'checks': self.checks
        }

def main():
    checker = GDPRComplianceChecker()

    checker.check_data_minimization()
    checker.check_right_to_access()
    checker.check_right_to_erasure()

    report = checker.generate_report()
    print(json.dumps(report, indent=2))

if __name__ == "__main__":
    main()
```


### 3.2 SOC 2åˆè§„
**SOC 2äº”å¤§ä¿¡ä»»åŸåˆ™**ï¼š

1ã€**å®‰å…¨æ€§ï¼ˆSecurityï¼‰**ï¼šé˜²æ­¢æœªæˆæƒè®¿é—®
2ã€**å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰**ï¼šç³»ç»Ÿæ­£å¸¸è¿è¡Œ
3ã€**å¤„ç†å®Œæ•´æ€§ï¼ˆProcessing Integrityï¼‰**ï¼šæ•°æ®å¤„ç†æ­£ç¡®
4ã€**æœºå¯†æ€§ï¼ˆConfidentialityï¼‰**ï¼šæ•æ„Ÿä¿¡æ¯ä¿å¯†
5ã€**éšç§æ€§ï¼ˆPrivacyï¼‰**ï¼šä¸ªäººä¿¡æ¯ä¿æŠ¤

**SOC 2å®¡è®¡æ—¥å¿—è¦æ±‚**ï¼š
```python
#!/usr/bin/env python3
"""
SOC 2å®¡è®¡æ—¥å¿—ç³»ç»Ÿ
"""

import json
import logging
from datetime import datetime
from typing import Dict, Optional

class SOC2AuditLogger:
    """SOC 2å®¡è®¡æ—¥å¿—è®°å½•å™¨"""

    def __init__(self, log_file: str = "soc2_audit.log"):
        self.logger = logging.getLogger('SOC2Audit')
        self.logger.setLevel(logging.INFO)

        handler = logging.FileHandler(log_file)
        handler.setFormatter(logging.Formatter(
            '%(asctime)s - %(levelname)s - %(message)s'
        ))
        self.logger.addHandler(handler)

    def log_access(
        self,
        user_id: str,
        resource: str,
        action: str,
        result: str,
        ip_address: Optional[str] = None
    ):
        """è®°å½•è®¿é—®äº‹ä»¶"""
        self.logger.info(json.dumps({
            'event_type': 'access',
            'timestamp': datetime.now().isoformat(),
            'user_id': user_id,
            'resource': resource,
            'action': action,
            'result': result,
            'ip_address': ip_address
        }))

    def log_data_change(
        self,
        user_id: str,
        resource: str,
        operation: str,
        old_value: Optional[str],
        new_value: str
    ):
        """è®°å½•æ•°æ®å˜æ›´"""
        self.logger.info(json.dumps({
            'event_type': 'data_change',
            'timestamp': datetime.now().isoformat(),
            'user_id': user_id,
            'resource': resource,
            'operation': operation,
            'old_value': old_value,
            'new_value': new_value
        }))

    def log_security_event(
        self,
        event_type: str,
        severity: str,
        description: str,
        ip_address: Optional[str] = None
    ):
        """è®°å½•å®‰å…¨äº‹ä»¶"""
        self.logger.warning(json.dumps({
            'event_type': 'security',
            'timestamp': datetime.now().isoformat(),
            'security_event_type': event_type,
            'severity': severity,
            'description': description,
            'ip_address': ip_address
        }))

# ä½¿ç”¨ç¤ºä¾‹
audit_logger = SOC2AuditLogger()

# è®°å½•API Keyè®¿é—®
audit_logger.log_access(
    user_id='user123',
    resource='api_key',
    action='read',
    result='success',
    ip_address='192.168.1.100'
)

# è®°å½•å¯†é’¥è½®æ¢
audit_logger.log_data_change(
    user_id='admin',
    resource='api_key',
    operation='rotate',
    old_value='sk-ant-api03-old***',
    new_value='sk-ant-api03-new***'
)

# è®°å½•å¼‚å¸¸è®¿é—®
audit_logger.log_security_event(
    event_type='unusual_access',
    severity='high',
    description='API access from unusual location',
    ip_address='203.0.113.42'
)
```


## Part 4: å®‰å…¨å®¡è®¡å·¥å…·ï¼ˆ2,000å­—ï¼‰
### 4.1 å®Œæ•´çš„å®‰å…¨æ‰«æè„šæœ¬
```bash
#!/bin/bash
# comprehensive-security-scan.sh - ç»¼åˆå®‰å…¨æ‰«æ
# ä½œè€…: è€é‡‘
# ç‰ˆæœ¬: 3.0

set -e

# ==================== é…ç½® ====================
REPORT_DIR="security-reports"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
REPORT_FILE="$REPORT_DIR/security-scan-$TIMESTAMP.json"

# ==================== é¢œè‰²å®šä¹‰ ====================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ==================== æ—¥å¿—å‡½æ•° ====================
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_section() {
    echo ""
    echo -e "${BLUE}======================================${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}======================================${NC}"
}

# ==================== åˆå§‹åŒ– ====================
init() {
    mkdir -p "$REPORT_DIR"
    log_info "ç»¼åˆå®‰å…¨æ‰«æå¼€å§‹..."
}

# ==================== 1. Git Secretsæ‰«æ ====================
scan_git_secrets() {
    log_section "1. Git Secretsæ‰«æ"

    if command -v gitleaks &> /dev/null; then
        gitleaks detect --source . --report-path "$REPORT_DIR/gitleaks-$TIMESTAMP.json"
        log_info "Git Secretsæ‰«æå®Œæˆ"
    else
        log_warn "æœªå®‰è£…gitleaksï¼Œè·³è¿‡æ‰«æ"
    fi
}

# ==================== 2. ä¾èµ–æ¼æ´æ‰«æ ====================
scan_dependencies() {
    log_section "2. ä¾èµ–æ¼æ´æ‰«æ"

    # Pythonä¾èµ–
    if [[ -f "requirements.txt" ]]; then
        log_info "æ‰«æPythonä¾èµ–..."
        if command -v safety &> /dev/null; then
            safety check --file requirements.txt --json > "$REPORT_DIR/safety-$TIMESTAMP.json" || true
        else
            log_warn "æœªå®‰è£…safetyï¼Œè·³è¿‡Pythonä¾èµ–æ‰«æ"
        fi
    fi

    # Node.jsä¾èµ–
    if [[ -f "package.json" ]]; then
        log_info "æ‰«æNode.jsä¾èµ–..."
        if command -v npm &> /dev/null; then
            npm audit --json > "$REPORT_DIR/npm-audit-$TIMESTAMP.json" || true
        else
            log_warn "æœªå®‰è£…npmï¼Œè·³è¿‡Node.jsä¾èµ–æ‰«æ"
        fi
    fi
}

# ==================== 3. ä»£ç å®‰å…¨æ‰«æ ====================
scan_code_security() {
    log_section "3. ä»£ç å®‰å…¨æ‰«æ"

    # Pythonä»£ç 
    if command -v bandit &> /dev/null; then
        log_info "ä½¿ç”¨Banditæ‰«æPythonä»£ç ..."
        bandit -r . -f json -o "$REPORT_DIR/bandit-$TIMESTAMP.json" || true
    else
        log_warn "æœªå®‰è£…banditï¼Œè·³è¿‡Pythonä»£ç æ‰«æ"
    fi

    # JavaScript/TypeScriptä»£ç 
    if command -v eslint &> /dev/null; then
        log_info "ä½¿ç”¨ESLintæ‰«æJavaScriptä»£ç ..."
        eslint . --format json --output-file "$REPORT_DIR/eslint-$TIMESTAMP.json" || true
    else
        log_warn "æœªå®‰è£…eslintï¼Œè·³è¿‡JavaScriptä»£ç æ‰«æ"
    fi
}

# ==================== 4. å®¹å™¨é•œåƒæ‰«æ ====================
scan_docker_images() {
    log_section "4. å®¹å™¨é•œåƒæ‰«æ"

    if command -v trivy &> /dev/null; then
        log_info "ä½¿ç”¨Trivyæ‰«æDockeré•œåƒ..."

        # æ‰«ææ‰€æœ‰æœ¬åœ°é•œåƒ
        docker images --format "{{.Repository}}:{{.Tag}}" | while read -r image; do
            if [[ "$image" != "<none>:<none>" ]]; then
                log_info "æ‰«æé•œåƒ: $image"
                trivy image --format json --output "$REPORT_DIR/trivy-${image//[:\/]/_}-$TIMESTAMP.json" "$image" || true
            fi
        done
    else
        log_warn "æœªå®‰è£…trivyï¼Œè·³è¿‡å®¹å™¨æ‰«æ"
    fi
}

# ==================== 5. é…ç½®æ–‡ä»¶å®‰å…¨æ£€æŸ¥ ====================
scan_config_files() {
    log_section "5. é…ç½®æ–‡ä»¶å®‰å…¨æ£€æŸ¥"

    log_info "æ£€æŸ¥.envæ–‡ä»¶..."

    # æ£€æŸ¥.envæ˜¯å¦åœ¨.gitignoreä¸­
    if [[ -f ".env" ]]; then
        if grep -q "^\.env$" .gitignore 2>/dev/null; then
            log_info ".envå·²åœ¨.gitignoreä¸­"
        else
            log_error ".envæœªåœ¨.gitignoreä¸­ï¼"
        fi
    fi

    # æ£€æŸ¥é…ç½®æ–‡ä»¶æƒé™
    log_info "æ£€æŸ¥é…ç½®æ–‡ä»¶æƒé™..."

    find . -name "*.env" -o -name "config.json" -o -name "secrets.yaml" | while read -r file; do
        perms=$(stat -c "%a" "$file" 2>/dev/null || stat -f "%A" "$file" 2>/dev/null)

        if [[ "$perms" != "600" ]] && [[ "$perms" != "400" ]]; then
            log_warn "æ–‡ä»¶æƒé™ä¸å®‰å…¨: $file ($perms)"
        fi
    done
}

# ==================== 6. ç½‘ç»œå®‰å…¨æ‰«æ ====================
scan_network() {
    log_section "6. ç½‘ç»œå®‰å…¨æ‰«æ"

    if command -v nmap &> /dev/null; then
        log_info "æ‰«æå¼€æ”¾ç«¯å£..."
        nmap -sV localhost -oX "$REPORT_DIR/nmap-$TIMESTAMP.xml" || true
    else
        log_warn "æœªå®‰è£…nmapï¼Œè·³è¿‡ç½‘ç»œæ‰«æ"
    fi
}

# ==================== 7. SSL/TLSæ£€æŸ¥ ====================
scan_ssl() {
    log_section "7. SSL/TLSæ£€æŸ¥"

    if command -v testssl &> /dev/null; then
        log_info "æ£€æŸ¥SSL/TLSé…ç½®..."
        # ç¤ºä¾‹ï¼šæ£€æŸ¥APIç«¯ç‚¹
        testssl --jsonfile "$REPORT_DIR/testssl-$TIMESTAMP.json" https://api.anthropic.com || true
    else
        log_warn "æœªå®‰è£…testssl.shï¼Œè·³è¿‡SSLæ£€æŸ¥"
    fi
}

# ==================== 8. ç”Ÿæˆç»¼åˆæŠ¥å‘Š ====================
generate_report() {
    log_section "8. ç”Ÿæˆç»¼åˆæŠ¥å‘Š"

    # åˆå¹¶æ‰€æœ‰æ‰«æç»“æœ
    python3 <<EOF
import json
import glob

report = {
    "timestamp": "$TIMESTAMP",
    "scans": {}
}

# è¯»å–æ‰€æœ‰JSONæŠ¥å‘Š
for file in glob.glob("$REPORT_DIR/*-$TIMESTAMP.json"):
    scan_name = file.split('/')[-1].split('-')[0]
    try:
        with open(file) as f:
            report["scans"][scan_name] = json.load(f)
    except:
        pass

# ä¿å­˜ç»¼åˆæŠ¥å‘Š
with open("$REPORT_FILE", "w") as f:
    json.dump(report, f, indent=2)

print(f"ç»¼åˆæŠ¥å‘Šå·²ä¿å­˜åˆ°: $REPORT_FILE")
EOF
}

# ==================== ä¸»å‡½æ•° ====================
main() {
    init

    scan_git_secrets
    scan_dependencies
    scan_code_security
    scan_docker_images
    scan_config_files
    scan_network
    scan_ssl

    generate_report

    log_info "å®‰å…¨æ‰«æå®Œæˆï¼"
    log_info "æŠ¥å‘Šä½ç½®: $REPORT_FILE"
}

main
```

**ğŸ“¸ æˆªå›¾ä½ç½®ï¼šç»¼åˆå®‰å…¨æ‰«ææ‰§è¡Œç»“æœ**


## Part 5: äº‹æ•…å“åº”æµç¨‹ï¼ˆ1,500å­—ï¼‰
### 5.1 APIæ³„éœ²åº”æ€¥é¢„æ¡ˆ
**åº”æ€¥å“åº”æµç¨‹å›¾**ï¼š
```
API Keyæ³„éœ²æ£€æµ‹
       â†“
[è‡ªåŠ¨å‘Šè­¦] â† Slack/é‚®ä»¶/çŸ­ä¿¡
       â†“
[ç«‹å³å“åº”] - 5åˆ†é’Ÿå†…
â”œâ”€â”€ 1. æ’¤é”€æ³„éœ²çš„å¯†é’¥
â”œâ”€â”€ 2. ç”Ÿæˆæ–°å¯†é’¥
â”œâ”€â”€ 3. æ›´æ–°æ‰€æœ‰æœåŠ¡
â””â”€â”€ 4. é€šçŸ¥ç›¸å…³äººå‘˜
       â†“
[è°ƒæŸ¥åˆ†æ] - 1å°æ—¶å†…
â”œâ”€â”€ 5. åˆ†ææ³„éœ²åŸå› 
â”œâ”€â”€ 6. è¯„ä¼°å½±å“èŒƒå›´
â”œâ”€â”€ 7. æ£€æŸ¥å¼‚å¸¸ä½¿ç”¨
â””â”€â”€ 8. è®°å½•å®¡è®¡æ—¥å¿—
       â†“
[ä¿®å¤åŠ å›º] - 24å°æ—¶å†…
â”œâ”€â”€ 9. ä¿®å¤æ³„éœ²æº
â”œâ”€â”€ 10. åŠ å¼ºè®¿é—®æ§åˆ¶
â”œâ”€â”€ 11. æ›´æ–°å®‰å…¨ç­–ç•¥
â””â”€â”€ 12. åŸ¹è®­ç›¸å…³äººå‘˜
       â†“
[å¤ç›˜æ€»ç»“] - 72å°æ—¶å†…
â”œâ”€â”€ 13. ç¼–å†™äº‹æ•…æŠ¥å‘Š
â”œâ”€â”€ 14. æ”¹è¿›å“åº”æµç¨‹
â””â”€â”€ 15. é¢„é˜²ç±»ä¼¼äº‹æ•…
```

**è‡ªåŠ¨åŒ–åº”æ€¥å“åº”è„šæœ¬**ï¼š
```bash
#!/bin/bash
# emergency-response.sh - APIæ³„éœ²åº”æ€¥å“åº”è„šæœ¬
# ä½œè€…: è€é‡‘
# ç‰ˆæœ¬: 1.0

set -e

LEAKED_KEY="$1"
INCIDENT_ID="incident-$(date +%Y%m%d-%H%M%S)"

log_incident() {
    echo "[$(date -Iseconds)] $1" >> "/var/log/security-incidents/$INCIDENT_ID.log"
}

# æ­¥éª¤1ï¼šæ’¤é”€æ³„éœ²çš„å¯†é’¥
revoke_leaked_key() {
    log_incident "æ’¤é”€æ³„éœ²å¯†é’¥: ${LEAKED_KEY:0:20}..."

    # è°ƒç”¨Anthropic APIæ’¤é”€
    curl -X POST https://api.anthropic.com/v1/keys/revoke \
        -H "x-api-key: $MASTER_KEY" \
        -d "{\"key\": \"$LEAKED_KEY\"}"

    log_incident "å¯†é’¥å·²æ’¤é”€"
}

# æ­¥éª¤2ï¼šç”Ÿæˆæ–°å¯†é’¥
generate_new_key() {
    log_incident "ç”Ÿæˆæ–°å¯†é’¥..."

    NEW_KEY=$(curl -X POST https://api.anthropic.com/v1/keys \
        -H "x-api-key: $MASTER_KEY" \
        -d '{"name": "emergency-replacement"}' | jq -r '.key')

    vault kv put secret/anthropic/api-key key="$NEW_KEY"

    log_incident "æ–°å¯†é’¥å·²ç”Ÿæˆå¹¶å­˜å‚¨åˆ°Vault"
}

# æ­¥éª¤3ï¼šé€šçŸ¥æ‰€æœ‰äºº
notify_team() {
    log_incident "é€šçŸ¥å›¢é˜Ÿ..."

    curl -X POST "$SLACK_WEBHOOK_URL" \
        -d "{
            \"text\": \"ğŸš¨ å®‰å…¨äº‹ä»¶ï¼šAPIå¯†é’¥æ³„éœ²\",
            \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"APIå¯†é’¥æ³„éœ²å·²æ£€æµ‹å¹¶å¤„ç†\\näº‹æ•…ID: $INCIDENT_ID\"
                }
            }]
        }"

    log_incident "å›¢é˜Ÿå·²é€šçŸ¥"
}

# ä¸»å‡½æ•°
main() {
    log_incident "å¼€å§‹åº”æ€¥å“åº”æµç¨‹"

    revoke_leaked_key
    generate_new_key
    notify_team

    log_incident "åº”æ€¥å“åº”å®Œæˆ"
}

main
```


## Part 6: å®‰å…¨æœ€ä½³å®è·µæ¸…å•ï¼ˆ2,000å­—ï¼‰
### 6.1 ä¼ä¸šçº§å®‰å…¨æ£€æŸ¥æ¸…å•
**20æ¡é»„é‡‘å®‰å…¨è§„åˆ™**ï¼š


**#**ï¼š1
**è§„åˆ™**ï¼šAPI Keyæ°¸è¿œä¸ç¡¬ç¼–ç 
**æ£€æŸ¥æ–¹æ³•**ï¼šGit Secretsæ‰«æ
**ä¼˜å…ˆçº§**ï¼š**P0**


**#**ï¼š2
**è§„åˆ™**ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–Secrets Manager
**æ£€æŸ¥æ–¹æ³•**ï¼šä»£ç å®¡æŸ¥
**ä¼˜å…ˆçº§**ï¼š**P0**


**#**ï¼š3
**è§„åˆ™**ï¼šæ¯90å¤©è½®æ¢ä¸€æ¬¡å¯†é’¥
**æ£€æŸ¥æ–¹æ³•**ï¼šè‡ªåŠ¨åŒ–è„šæœ¬
**ä¼˜å…ˆçº§**ï¼š**P0**


**#**ï¼š4
**è§„åˆ™**ï¼šé™åˆ¶APIé€Ÿç‡
**æ£€æŸ¥æ–¹æ³•**ï¼šé…ç½®æ£€æŸ¥
**ä¼˜å…ˆçº§**ï¼š**P0**


**#**ï¼š5
**è§„åˆ™**ï¼šè®°å½•æ‰€æœ‰APIè®¿é—®
**æ£€æŸ¥æ–¹æ³•**ï¼šå®¡è®¡æ—¥å¿—
**ä¼˜å…ˆçº§**ï¼š**P0**


**#**ï¼š6
**è§„åˆ™**ï¼šå¼‚å¸¸è®¿é—®ç«‹å³å‘Šè­¦
**æ£€æŸ¥æ–¹æ³•**ï¼šç›‘æ§ç³»ç»Ÿ
**ä¼˜å…ˆçº§**ï¼š**P0**


**#**ï¼š7
**è§„åˆ™**ï¼šæ•æ„Ÿæ•°æ®å¿…é¡»åŠ å¯†
**æ£€æŸ¥æ–¹æ³•**ï¼šæ•°æ®å®¡è®¡
**ä¼˜å…ˆçº§**ï¼š**P1**


**#**ï¼š8
**è§„åˆ™**ï¼šæ—¥å¿—è‡ªåŠ¨è„±æ•
**æ£€æŸ¥æ–¹æ³•**ï¼šæ—¥å¿—æ£€æŸ¥
**ä¼˜å…ˆçº§**ï¼š**P1**


**#**ï¼š9
**è§„åˆ™**ï¼šå®šæœŸå®‰å…¨æ‰«æ
**æ£€æŸ¥æ–¹æ³•**ï¼šCI/CDé›†æˆ
**ä¼˜å…ˆçº§**ï¼š**P1**


**#**ï¼š10
**è§„åˆ™**ï¼šä¾èµ–æ¼æ´æ£€æŸ¥
**æ£€æŸ¥æ–¹æ³•**ï¼šSafety/npm audit
**ä¼˜å…ˆçº§**ï¼š**P1**


**#**ï¼š11
**è§„åˆ™**ï¼šæœ€å°æƒé™åŸåˆ™
**æ£€æŸ¥æ–¹æ³•**ï¼šæƒé™å®¡è®¡
**ä¼˜å…ˆçº§**ï¼š**P1**


**#**ï¼š12
**è§„åˆ™**ï¼šå¤šå› ç´ è®¤è¯ï¼ˆ2FAï¼‰
**æ£€æŸ¥æ–¹æ³•**ï¼šç”¨æˆ·è´¦æˆ·æ£€æŸ¥
**ä¼˜å…ˆçº§**ï¼š**P1**


**#**ï¼š13
**è§„åˆ™**ï¼šç½‘ç»œéš”ç¦»
**æ£€æŸ¥æ–¹æ³•**ï¼šç½‘ç»œé…ç½®
**ä¼˜å…ˆçº§**ï¼š**P2**


**#**ï¼š14
**è§„åˆ™**ï¼šSSL/TLSåŠ å¯†
**æ£€æŸ¥æ–¹æ³•**ï¼šSSLæ£€æŸ¥
**ä¼˜å…ˆçº§**ï¼š**P2**


**#**ï¼š15
**è§„åˆ™**ï¼šé˜²ç«å¢™é…ç½®
**æ£€æŸ¥æ–¹æ³•**ï¼šç½‘ç»œå®‰å…¨
**ä¼˜å…ˆçº§**ï¼š**P2**


**#**ï¼š16
**è§„åˆ™**ï¼šå¤‡ä»½ä¸æ¢å¤
**æ£€æŸ¥æ–¹æ³•**ï¼šå¤‡ä»½æµ‹è¯•
**ä¼˜å…ˆçº§**ï¼š**P2**


**#**ï¼š17
**è§„åˆ™**ï¼šå®‰å…¨åŸ¹è®­
**æ£€æŸ¥æ–¹æ³•**ï¼šå›¢é˜ŸåŸ¹è®­è®°å½•
**ä¼˜å…ˆçº§**ï¼š**P2**


**#**ï¼š18
**è§„åˆ™**ï¼šäº‹æ•…å“åº”é¢„æ¡ˆ
**æ£€æŸ¥æ–¹æ³•**ï¼šæ¼”ç»ƒæµ‹è¯•
**ä¼˜å…ˆçº§**ï¼š**P2**


**#**ï¼š19
**è§„åˆ™**ï¼šåˆè§„æ€§å®¡è®¡
**æ£€æŸ¥æ–¹æ³•**ï¼šå®šæœŸå®¡è®¡
**ä¼˜å…ˆçº§**ï¼š**P3**


**#**ï¼š20
**è§„åˆ™**ï¼šå®‰å…¨æ–‡æ¡£æ›´æ–°
**æ£€æŸ¥æ–¹æ³•**ï¼šæ–‡æ¡£æ£€æŸ¥
**ä¼˜å…ˆçº§**ï¼š**P3**


### 6.2 è‡ªåŠ¨åŒ–å®‰å…¨æ£€æŸ¥è„šæœ¬
```python
#!/usr/bin/env python3
"""
è‡ªåŠ¨åŒ–å®‰å…¨æ£€æŸ¥å·¥å…·
æ¯æ—¥è¿è¡Œï¼Œç”Ÿæˆå®‰å…¨åˆè§„æŠ¥å‘Š
"""

import os
import json
import subprocess
from datetime import datetime
from typing import List, Dict

class SecurityChecker:
    """å®‰å…¨æ£€æŸ¥å™¨"""

    def __init__(self):
        self.checks = []
        self.total_score = 100
        self.deductions = 0

    def check_hardcoded_secrets(self) -> bool:
        """æ£€æŸ¥ç¡¬ç¼–ç çš„å¯†é’¥"""
        result = subprocess.run(
            ["grep", "-r", "sk-ant-api", "."],
            capture_output=True,
            text=True
        )

        if result.returncode == 0:
            self.deductions += 20
            self.checks.append({
                'name': 'ç¡¬ç¼–ç å¯†é’¥æ£€æŸ¥',
                'status': 'FAIL',
                'deduction': 20,
                'message': 'å‘ç°ç¡¬ç¼–ç çš„APIå¯†é’¥'
            })
            return False
        else:
            self.checks.append({
                'name': 'ç¡¬ç¼–ç å¯†é’¥æ£€æŸ¥',
                'status': 'PASS'
            })
            return True

    def check_env_file_in_gitignore(self) -> bool:
        """æ£€æŸ¥.envæ˜¯å¦åœ¨.gitignoreä¸­"""
        if os.path.exists('.env') and os.path.exists('.gitignore'):
            with open('.gitignore') as f:
                if '.env' not in f.read():
                    self.deductions += 10
                    self.checks.append({
                        'name': '.envæ–‡ä»¶ä¿æŠ¤',
                        'status': 'FAIL',
                        'deduction': 10,
                        'message': '.envæœªåœ¨.gitignoreä¸­'
                    })
                    return False

        self.checks.append({
            'name': '.envæ–‡ä»¶ä¿æŠ¤',
            'status': 'PASS'
        })
        return True

    def check_key_rotation_schedule(self) -> bool:
        """æ£€æŸ¥å¯†é’¥è½®æ¢è®¡åˆ’"""
        # æ£€æŸ¥crontabä¸­æ˜¯å¦æœ‰è½®æ¢ä»»åŠ¡
        result = subprocess.run(
            ["crontab", "-l"],
            capture_output=True,
            text=True
        )

        if 'rotate-api-keys.sh' in result.stdout:
            self.checks.append({
                'name': 'å¯†é’¥è½®æ¢è®¡åˆ’',
                'status': 'PASS'
            })
            return True
        else:
            self.deductions += 15
            self.checks.append({
                'name': 'å¯†é’¥è½®æ¢è®¡åˆ’',
                'status': 'FAIL',
                'deduction': 15,
                'message': 'æœªè®¾ç½®å¯†é’¥è½®æ¢å®šæ—¶ä»»åŠ¡'
            })
            return False

    def check_audit_logging(self) -> bool:
        """æ£€æŸ¥å®¡è®¡æ—¥å¿—"""
        if os.path.exists('/var/log/api-key-audit.db'):
            self.checks.append({
                'name': 'å®¡è®¡æ—¥å¿—',
                'status': 'PASS'
            })
            return True
        else:
            self.deductions += 10
            self.checks.append({
                'name': 'å®¡è®¡æ—¥å¿—',
                'status': 'FAIL',
                'deduction': 10,
                'message': 'æœªå¯ç”¨å®¡è®¡æ—¥å¿—'
            })
            return False

    def check_rate_limiting(self) -> bool:
        """æ£€æŸ¥é€Ÿç‡é™åˆ¶"""
        # æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­æ˜¯å¦è®¾ç½®äº†é€Ÿç‡é™åˆ¶
        # ç®€åŒ–ç¤ºä¾‹
        self.checks.append({
            'name': 'APIé€Ÿç‡é™åˆ¶',
            'status': 'PASS'
        })
        return True

    def generate_report(self) -> Dict:
        """ç”Ÿæˆå®‰å…¨æ£€æŸ¥æŠ¥å‘Š"""
        final_score = self.total_score - self.deductions

        # è¯„çº§
        if final_score >= 90:
            grade = 'A'
            level = 'Excellent'
        elif final_score >= 80:
            grade = 'B'
            level = 'Good'
        elif final_score >= 70:
            grade = 'C'
            level = 'Fair'
        else:
            grade = 'D'
            level = 'Poor'

        return {
            'timestamp': datetime.now().isoformat(),
            'score': final_score,
            'grade': grade,
            'level': level,
            'checks': self.checks,
            'recommendations': self.get_recommendations()
        }

    def get_recommendations(self) -> List[str]:
        """è·å–æ”¹è¿›å»ºè®®"""
        recommendations = []

        for check in self.checks:
            if check['status'] == 'FAIL':
                recommendations.append(
                    f"{check['name']}: {check['message']}"
                )

        return recommendations

def main():
    checker = SecurityChecker()

    # æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
    checker.check_hardcoded_secrets()
    checker.check_env_file_in_gitignore()
    checker.check_key_rotation_schedule()
    checker.check_audit_logging()
    checker.check_rate_limiting()

    # ç”ŸæˆæŠ¥å‘Š
    report = checker.generate_report()

    print("====================================")
    print("  å®‰å…¨åˆè§„æ£€æŸ¥æŠ¥å‘Š")
    print("====================================")
    print(f"æœ€ç»ˆå¾—åˆ†: {report['score']}/100")
    print(f"è¯„çº§: {report['grade']} ({report['level']})")
    print("")
    print("æ£€æŸ¥ç»“æœ:")
    for check in report['checks']:
        status = "âœ“" if check['status'] == 'PASS' else "âœ—"
        print(f"  {status} {check['name']}")

    if report['recommendations']:
        print("")
        print("æ”¹è¿›å»ºè®®:")
        for rec in report['recommendations']:
            print(f"  â€¢ {rec}")

    # ä¿å­˜JSONæŠ¥å‘Š
    with open('security-check-report.json', 'w') as f:
        json.dump(report, f, indent=2)

if __name__ == "__main__":
    main()
```

**è®¾ç½®æ¯æ—¥è‡ªåŠ¨æ£€æŸ¥**ï¼š
```bash
# æ¯å¤©æ—©ä¸Š9ç‚¹è¿è¡Œå®‰å…¨æ£€æŸ¥
0 9 * * * cd /path/to/project && python3 security-checker.py && mail -s "Security Report" security@example.com < security-check-report.json
```


## ğŸ“š è¯¾ç¨‹æ€»ç»“
**æœ¬èŠ‚æ ¸å¿ƒå†…å®¹**ï¼š

è€é‡‘æˆ‘æŠŠä¼ä¸šå®‰å…¨çš„æ ¸å¿ƒéƒ½å†™è¿›å»äº†ï¼Œè‰¹ï¼Œè¿™äº›éƒ½æ˜¯è¡€çš„æ•™è®­ï¼

1ã€âœ… **API Keyå®‰å…¨ç®¡ç†** - åˆ†çº§ç®¡ç†ã€Secrets Managerã€è‡ªåŠ¨è½®æ¢ã€è®¿é—®å®¡è®¡
2ã€âœ… **æ•æ„Ÿæ•°æ®ä¿æŠ¤** - Git Secretsæ‰«æã€æ—¥å¿—è„±æ•ã€æ•°æ®åŠ å¯†
3ã€âœ… **ä¼ä¸šåˆè§„è¦æ±‚** - GDPRã€HIPAAã€SOC 2å®¡è®¡æ—¥å¿—
4ã€âœ… **å®‰å…¨å®¡è®¡å·¥å…·** - 300è¡Œç»¼åˆæ‰«æè„šæœ¬ã€ä¾èµ–æ¼æ´ã€å®¹å™¨å®‰å…¨
5ã€âœ… **äº‹æ•…å“åº”æµç¨‹** - APIæ³„éœ²åº”æ€¥é¢„æ¡ˆã€è‡ªåŠ¨åŒ–å“åº”
6ã€âœ… **20æ¡å®‰å…¨æœ€ä½³å®è·µ** - è‡ªåŠ¨åŒ–æ£€æŸ¥è„šæœ¬ã€æ¯æ—¥åˆè§„æŠ¥å‘Š

**è€é‡‘çš„æœ€åè­¦å‘Š**ï¼š

è‰¹ï¼Œå®‰å…¨é—®é¢˜ç»å¯¹ä¸èƒ½é©¬è™ï¼ä¸€æ¬¡API Keyæ³„éœ²å¯èƒ½è®©å…¬å¸ç ´äº§ï¼

è®°ä½è¿™ä¸‰æ¡é“å¾‹ï¼š
1ã€**Never trust, always verify**ï¼ˆé›¶ä¿¡ä»»åŸåˆ™ï¼‰
2ã€**Defense in depth**ï¼ˆçºµæ·±é˜²å¾¡ï¼‰
3ã€**Fail securely**ï¼ˆå®‰å…¨å¤±è´¥ï¼‰


**ä¸‹ä¸€æ­¥**ï¼š

è¿›å…¥ **Module 9.1: ä¼ä¸šæ¡ˆä¾‹æ·±åº¦åˆ†æ**ï¼Œå­¦ä¹ çœŸå®ä¼ä¸šå¦‚ä½•ä½¿ç”¨Claude Codeã€‚


## ğŸ”— ç›¸å…³é“¾æ¥

**èµ„æº**ï¼š**Module 9.1**
**é“¾æ¥**ï¼š[ä¼ä¸šæ¡ˆä¾‹æ·±åº¦åˆ†æ](../../09-Agent-SDK/ä¼ä¸šæ¡ˆä¾‹æ·±åº¦åˆ†æ.md)


**èµ„æº**ï¼š**Module 8.1**
**é“¾æ¥**ï¼š[ä¼ä¸šå›¢é˜Ÿåä½œæœ€ä½³å®è·µ](./ä¼ä¸šå›¢é˜Ÿåä½œæœ€ä½³å®è·µ.md)


**èµ„æº**ï¼š**å®‰å…¨å·¥å…·**
**é“¾æ¥**ï¼š[OWASP Top 10](https://owasp.org/www-project-top-ten/)


**æ–‡æ¡£ç»“æŸ** | æ›´æ–°æ—¥æœŸï¼š2025-12-12 | ç‰ˆæœ¬ï¼š1.0
