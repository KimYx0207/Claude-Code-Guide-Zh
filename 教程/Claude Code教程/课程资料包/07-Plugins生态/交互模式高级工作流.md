# äº¤äº’æ¨¡å¼é«˜çº§å·¥ä½œæµ

**æ¨¡å—**ï¼šClaude Codeä¼ä¸šçº§ç³»ç»Ÿ
**è¯¾æ—¶**ï¼š07-02
**é¢„è®¡å­¦ä¹ æ—¶é—´**ï¼š5å°æ—¶
**éš¾åº¦ç­‰çº§**ï¼šå››æ˜ŸåŠ


## æ¦‚è¿°
Claude Code 2025æä¾›äº†ä¸‰ç§æ ¸å¿ƒäº¤äº’æ¨¡å¼ï¼Œæ¯ç§æ¨¡å¼éƒ½é’ˆå¯¹ä¸åŒå¤æ‚åº¦çš„ä»»åŠ¡åœºæ™¯è®¾è®¡ã€‚æŒæ¡è¿™ä¸‰ç§æ¨¡å¼çš„åˆ‡æ¢å’Œç»„åˆä½¿ç”¨ï¼Œæ˜¯æˆä¸ºClaude Codeé«˜çº§ç”¨æˆ·çš„å…³é”®ã€‚

æœ¬æ–‡æ¡£å°†æ·±å…¥è§£æä¸‰ç§äº¤äº’æ¨¡å¼çš„åŸç†ã€å®ç°å’Œæœ€ä½³å®è·µï¼ŒåŒ…å«å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’ŒçœŸå®æ¡ˆä¾‹åˆ†æã€‚

**ä½ å°†å­¦åˆ°**ï¼š
- ä¸‰ç§äº¤äº’æ¨¡å¼çš„æ ¸å¿ƒå·®å¼‚å’Œé€‚ç”¨åœºæ™¯
- Plan Modeçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸå’Œå®ç°åŸç†
- Multi-Agentåä½œçš„é€šä¿¡æœºåˆ¶å’ŒçŠ¶æ€ç®¡ç†
- Multi-turn Conversationçš„ä¸Šä¸‹æ–‡ä¼˜åŒ–ç­–ç•¥
- å·¥ä½œæµè‡ªåŠ¨åŒ–è„šæœ¬çš„å®Œæ•´å®ç°


## ç¬¬ä¸€ç« ï¼šäº¤äº’æ¨¡å¼æ¦‚è§ˆ
### 1.1 ä¸‰ç§äº¤äº’æ¨¡å¼å¯¹æ¯”
Claude Codeæä¾›ä¸‰ç§é€’è¿›å¼çš„äº¤äº’æ¨¡å¼ï¼š

#### æ¨¡å¼çŸ©é˜µå¯¹æ¯”

**ç»´åº¦**ï¼š**å¤æ‚åº¦**
**åŸºç¡€å¯¹è¯æ¨¡å¼**ï¼šä½
**Plan Mode**ï¼šä¸­
**Multi-Agentåä½œ**ï¼šé«˜


**ç»´åº¦**ï¼š**æ‰§è¡Œæ—¶é—´**
**åŸºç¡€å¯¹è¯æ¨¡å¼**ï¼šå®æ—¶
**Plan Mode**ï¼šåˆ†é’Ÿçº§
**Multi-Agentåä½œ**ï¼šå¯è·¨ä¼šè¯


**ç»´åº¦**ï¼š**çŠ¶æ€ç®¡ç†**
**åŸºç¡€å¯¹è¯æ¨¡å¼**ï¼šå•çº¿ç¨‹
**Plan Mode**ï¼šæœ‰è®¡åˆ’çŠ¶æ€
**Multi-Agentåä½œ**ï¼šå¤šAgentçŠ¶æ€åŒæ­¥


**ç»´åº¦**ï¼š**é€‚ç”¨ä»»åŠ¡**
**åŸºç¡€å¯¹è¯æ¨¡å¼**ï¼šå•æ–‡ä»¶ç¼–è¾‘ã€ç®€å•æŸ¥è¯¢
**Plan Mode**ï¼šå¤šæ–‡ä»¶é‡æ„ã€æ¶æ„è®¾è®¡
**Multi-Agentåä½œ**ï¼šå¤§è§„æ¨¡é‡æ„ã€å¹¶è¡Œå¼€å‘


**ç»´åº¦**ï¼š**ç”¨æˆ·æ§åˆ¶**
**åŸºç¡€å¯¹è¯æ¨¡å¼**ï¼šé€æ­¥äº¤äº’
**Plan Mode**ï¼šå®¡æ‰¹è®¡åˆ’åè‡ªåŠ¨æ‰§è¡Œ
**Multi-Agentåä½œ**ï¼šå®šä¹‰ä»»åŠ¡åå¹¶è¡Œæ‰§è¡Œ


**ç»´åº¦**ï¼š**é”™è¯¯æ¢å¤**
**åŸºç¡€å¯¹è¯æ¨¡å¼**ï¼šæ‰‹åŠ¨é‡è¯•
**Plan Mode**ï¼šPlanå†…è‡ªåŠ¨é‡è¯•
**Multi-Agentåä½œ**ï¼šAgentçº§éš”ç¦»æ¢å¤


**ç»´åº¦**ï¼š**æˆæœ¬**
**åŸºç¡€å¯¹è¯æ¨¡å¼**ï¼šä½
**Plan Mode**ï¼šä¸­
**Multi-Agentåä½œ**ï¼šé«˜ï¼ˆå¤šAgentå¹¶è¡Œï¼‰


#### æ¨¡å¼é€‰æ‹©å†³ç­–æ ‘
```
ç”¨æˆ·éœ€æ±‚
    â”‚
    â–¼
æ˜¯å¦è·¨å¤šä¸ªæ–‡ä»¶ï¼Ÿ
    â”œâ”€ å¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> åŸºç¡€å¯¹è¯æ¨¡å¼
    â”‚
    â””â”€ æ˜¯
        â”‚
        â–¼
    æ˜¯å¦éœ€è¦äººå·¥å®¡æ‰¹ï¼Ÿ
        â”œâ”€ æ˜¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Plan Mode
        â”‚
        â””â”€ å¦
            â”‚
            â–¼
        æ˜¯å¦å¯å¹¶è¡Œæ‰§è¡Œï¼Ÿ
            â”œâ”€ æ˜¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€> Multi-Agentåä½œ
            â”‚
            â””â”€ å¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€> Plan Modeï¼ˆä¸²è¡Œæ‰§è¡Œï¼‰
```

ğŸ“¸ **æˆªå›¾ä½ç½®**ï¼š[æ˜¾ç¤ºClaude Codeç•Œé¢ä¸­ä¸‰ç§æ¨¡å¼çš„åˆ‡æ¢æŒ‰é’®å’Œå½“å‰æ¨¡å¼æŒ‡ç¤ºå™¨]

### 1.2 åŸºç¡€å¯¹è¯æ¨¡å¼ï¼ˆStandard Chatï¼‰
**å®šä¹‰**ï¼šæœ€åŸºæœ¬çš„äº¤äº’æ¨¡å¼ï¼Œç”¨æˆ·å’ŒClaudeè¿›è¡Œæ¥å›å¯¹è¯ï¼Œæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹å¤„ç†ã€‚

**ç‰¹ç‚¹**ï¼š
- âœ… å“åº”é€Ÿåº¦å¿«ï¼ˆç§’çº§ï¼‰
- âœ… é€‚åˆæ¢ç´¢æ€§ä»»åŠ¡
- âœ… æ˜“äºç†è§£å’Œä½¿ç”¨
- âŒ ç¼ºä¹å…¨å±€è§„åˆ’
- âŒ è·¨æ–‡ä»¶æ“ä½œå¤æ‚
- âŒ å®¹æ˜“é—æ¼ç»†èŠ‚

**å…¸å‹åœºæ™¯**ï¼š
```
ç”¨æˆ·: "ä¿®å¤è¿™ä¸ªå‡½æ•°çš„ç©ºæŒ‡é’ˆBug"
Claude: [åˆ†æä»£ç ] -> [å®šä½é—®é¢˜] -> [ä¿®å¤å¹¶æµ‹è¯•]

ç”¨æˆ·: "æ·»åŠ ä¸€ä¸ªæ—¥å¿—è®°å½•åŠŸèƒ½"
Claude: [äº†è§£éœ€æ±‚] -> [å®ç°åŠŸèƒ½] -> [å±•ç¤ºä»£ç ]
```

**ä½•æ—¶ä½¿ç”¨**ï¼š
- å•æ–‡ä»¶ç¼–è¾‘ï¼ˆ<50è¡Œä¿®æ”¹ï¼‰
- ä»£ç è§£é‡Šå’Œå®¡æŸ¥
- å¿«é€ŸåŸå‹éªŒè¯
- Bugä¿®å¤
- é…ç½®æ–‡ä»¶è°ƒæ•´

**å±€é™æ€§åˆ†æ**ï¼š

1ã€**ä¸Šä¸‹æ–‡ä¸¢å¤±é£é™©**ï¼šé•¿å¯¹è¯ä¸­ï¼ŒClaudeå¯èƒ½å¿˜è®°æ—©æœŸè®¨è®ºçš„ç»†èŠ‚
2ã€**ç¼ºä¹å…¨å±€è§†è§’**ï¼šæ¯æ¬¡æ“ä½œéƒ½æ˜¯å±€éƒ¨çš„ï¼Œéš¾ä»¥ä¿è¯æ•´ä½“ä¸€è‡´æ€§
3ã€**æ‰‹åŠ¨åè°ƒæˆæœ¬é«˜**ï¼šç”¨æˆ·éœ€è¦äººå·¥åè°ƒå¤šä¸ªæ­¥éª¤çš„æ‰§è¡Œé¡ºåº

### 1.3 Plan Modeæ¦‚è§ˆ
**å®šä¹‰**ï¼šå…ˆè§„åˆ’å†æ‰§è¡Œçš„æ¨¡å¼ã€‚Claudeå…ˆç”Ÿæˆå®Œæ•´è®¡åˆ’ï¼Œç”¨æˆ·å®¡æ‰¹åè‡ªåŠ¨æ‰§è¡Œã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
1ã€**é£é™©é¢„è§ˆ**ï¼šæ‰§è¡Œå‰çœ‹åˆ°å®Œæ•´è®¡åˆ’ï¼Œé¿å…æ„å¤–ä¿®æ”¹
2ã€**å…¨å±€è§†è§’**ï¼šç¡®ä¿æ‰€æœ‰ä¿®æ”¹ååŒä¸€è‡´
3ã€**å¯è¿½æº¯æ€§**ï¼šæ˜ç¡®çš„è®¡åˆ’æ–‡æ¡£ä¾¿äºäº‹åå®¡æŸ¥

**ç”Ÿå‘½å‘¨æœŸ**ï¼š
```
è§¦å‘EnterPlanMode
    â†“
æœé›†ä¸Šä¸‹æ–‡ï¼ˆGlob/Grep/Readï¼‰
    â†“
ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼ˆPlan.mdï¼‰
    â†“
ç”¨æˆ·å®¡æ‰¹ï¼ˆApprove/Reject/Modifyï¼‰
    â†“
æ‰§è¡Œè®¡åˆ’ï¼ˆæ‰¹é‡Edit/Writeæ“ä½œï¼‰
    â†“
éªŒè¯ç»“æœï¼ˆè¿è¡Œæµ‹è¯•/æ£€æŸ¥ï¼‰
    â†“
ExitPlanModeï¼ˆè¾“å‡ºæ€»ç»“ï¼‰
```

**ä½•æ—¶è‡ªåŠ¨è§¦å‘**ï¼š

Claude Codeä¼šåœ¨ä»¥ä¸‹åœºæ™¯è‡ªåŠ¨å»ºè®®è¿›å…¥Plan Modeï¼š
1ã€ç”¨æˆ·æåˆ°"é‡æ„"ã€"è¿ç§»"ã€"ä¼˜åŒ–æ¶æ„"ç­‰å…³é”®è¯
2ã€éœ€è¦ä¿®æ”¹è¶…è¿‡3ä¸ªæ–‡ä»¶
3ã€æ¶‰åŠAPI breaking changes
4ã€éœ€è¦æ•°æ®åº“schemaå˜æ›´
5ã€è·¨æ¨¡å—çš„ä¾èµ–å…³ç³»è°ƒæ•´

### 1.4 Multi-Agentåä½œæ¦‚è§ˆ
**å®šä¹‰**ï¼šå¤šä¸ªClaude Agentå¹¶è¡Œå·¥ä½œï¼Œå„è‡ªè´Ÿè´£ç‹¬ç«‹çš„å­ä»»åŠ¡ï¼Œé€šè¿‡å…±äº«çŠ¶æ€åè°ƒã€‚

**æ¶æ„æ¨¡å‹**ï¼š
```
                 ä¸»Agentï¼ˆCoordinatorï¼‰
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
    Agent 1         Agent 2         Agent 3
  (å‰ç«¯å®ç°)      (åç«¯API)       (æ•°æ®åº“è¿ç§»)
        â”‚               â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                 SharedStateManager
                  (çŠ¶æ€åŒæ­¥)
```

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- ğŸš€ **å¹¶è¡ŒåŠ é€Ÿ**ï¼š3ä¸ªAgentå¯å°†3å°æ—¶ä»»åŠ¡å‹ç¼©åˆ°1å°æ—¶
- ğŸ”’ **é£é™©éš”ç¦»**ï¼šæŸä¸ªAgentå¤±è´¥ä¸å½±å“å…¶ä»–Agent
- ğŸ§© **ä¸“ä¸šåŒ–åˆ†å·¥**ï¼šæ¯ä¸ªAgentä¸“æ³¨ç‰¹å®šé¢†åŸŸï¼ˆå¦‚å‰ç«¯/åç«¯/æµ‹è¯•ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- å‰åç«¯åˆ†ç¦»å¼€å‘
- å¤§è§„æ¨¡ä»£ç é‡æ„ï¼ˆ>10ä¸ªæ–‡ä»¶ï¼‰
- å¤šæ¨¡å—å¹¶è¡Œå¼€å‘
- CI/CD Pipelineæ„å»º
- æ–‡æ¡£+ä»£ç åŒæ­¥æ›´æ–°

### 1.5 æ¨¡å¼åˆ‡æ¢æœ€ä½³å®è·µ
**åŸåˆ™ä¸€ï¼šä»ç®€å•å¼€å§‹ï¼Œé€æ­¥å‡çº§**
```
é¦–æ¬¡å°è¯• -> åŸºç¡€å¯¹è¯
å‘ç°å¤æ‚ -> åˆ‡æ¢åˆ°Plan Mode
æå…¶å¤æ‚ -> è€ƒè™‘Multi-Agent
```

**åŸåˆ™äºŒï¼šæ˜ç¡®ä»»åŠ¡è¾¹ç•Œ**
```
å•ä¸€èŒè´£ -> åŸºç¡€å¯¹è¯
æœ‰æ˜ç¡®è®¡åˆ’ -> Plan Mode
å¯æ‹†åˆ†å¹¶è¡Œ -> Multi-Agent
```

**åŸåˆ™ä¸‰ï¼šè€ƒè™‘æˆæœ¬æ”¶ç›Š**


**æ¨¡å¼**ï¼šåŸºç¡€å¯¹è¯
**Tokenæ¶ˆè€—**ï¼šä½ï¼ˆ1k-10kï¼‰
**æ‰§è¡Œæ—¶é—´**ï¼šç§’çº§
**é€‚ç”¨é¡¹ç›®è§„æ¨¡**ï¼šä¸ªäººå°é¡¹ç›®


**æ¨¡å¼**ï¼šPlan Mode
**Tokenæ¶ˆè€—**ï¼šä¸­ï¼ˆ10k-50kï¼‰
**æ‰§è¡Œæ—¶é—´**ï¼šåˆ†é’Ÿçº§
**é€‚ç”¨é¡¹ç›®è§„æ¨¡**ï¼šä¸­å‹é¡¹ç›®


**æ¨¡å¼**ï¼šMulti-Agent
**Tokenæ¶ˆè€—**ï¼šé«˜ï¼ˆ50k-200k+ï¼‰
**æ‰§è¡Œæ—¶é—´**ï¼šåˆ†é’Ÿåˆ°å°æ—¶
**é€‚ç”¨é¡¹ç›®è§„æ¨¡**ï¼šä¼ä¸šçº§é¡¹ç›®


ğŸ“¸ **æˆªå›¾ä½ç½®**ï¼š[æ˜¾ç¤ºä¸‰ç§æ¨¡å¼ä¸‹Tokenæ¶ˆè€—çš„å¯¹æ¯”æŸ±çŠ¶å›¾]


## ç¬¬äºŒç« ï¼šPlan Modeæ·±åº¦è§£æ
### 2.1 Plan Modeæ ¸å¿ƒåŸç†
**è®¾è®¡ç†å¿µ**ï¼š
Plan Modeå€Ÿé‰´äº†è½¯ä»¶å·¥ç¨‹ä¸­çš„"è®¾è®¡-å®¡æŸ¥-å®æ–½"æµç¨‹ï¼Œå°†AIçš„æ‰§è¡Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š
1ã€**Planningé˜¶æ®µ**ï¼šç”Ÿæˆè¯¦ç»†è®¡åˆ’ï¼Œäººç±»å®¡æŸ¥
2ã€**Executioné˜¶æ®µ**ï¼šæŒ‰è®¡åˆ’è‡ªåŠ¨æ‰§è¡Œ

è¿™ç§è®¾è®¡é¿å…äº†"AIç›´æ¥åŠ¨æ‰‹"å¯èƒ½å¸¦æ¥çš„é£é™©ï¼ŒåŒæ—¶ä¿æŒäº†è‡ªåŠ¨åŒ–çš„æ•ˆç‡ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦Plan Modeï¼Ÿ**

ä¼ ç»Ÿå¯¹è¯æ¨¡å¼çš„ä¸‰å¤§é—®é¢˜ï¼š
1ã€**ç›²ç›®æ‰§è¡Œé£é™©**ï¼šClaudeå¯èƒ½ç†è§£åå·®ï¼Œç›´æ¥ä¿®æ”¹ä»£ç åéš¾ä»¥æ¢å¤
2ã€**ç¼ºä¹å…¨å±€åè°ƒ**ï¼šå¤šä¸ªæ–‡ä»¶çš„ä¿®æ”¹å¯èƒ½ä¸ä¸€è‡´
3ã€**è°ƒè¯•æˆæœ¬é«˜**ï¼šå‡ºé—®é¢˜åéœ€è¦åå¤ä¿®å¤

Plan Modeé€šè¿‡"å…ˆè®¡åˆ’åæ‰§è¡Œ"è§£å†³è¿™äº›é—®é¢˜ã€‚

### 2.2 Plan Modeç”Ÿå‘½å‘¨æœŸï¼ˆ7ä¸ªé˜¶æ®µï¼‰
#### é˜¶æ®µ1ï¼šè§¦å‘è¿›å…¥ï¼ˆTriggerï¼‰
**è‡ªåŠ¨è§¦å‘æ¡ä»¶**ï¼š
```python
# Claude Codeå†…éƒ¨åˆ¤æ–­é€»è¾‘ï¼ˆä¼ªä»£ç ï¼‰
def should_enter_plan_mode(user_request: str, context: Dict) -> bool:
    """åˆ¤æ–­æ˜¯å¦åº”è¯¥è¿›å…¥Plan Mode"""
    triggers = {
        'keywords': ['é‡æ„', 'è¿ç§»', 'ä¼˜åŒ–', 'é‡å†™', 'ç»Ÿä¸€'],
        'file_count': 3,  # æ¶‰åŠæ–‡ä»¶æ•°è¶…è¿‡3ä¸ª
        'breaking_changes': True,  # æ˜¯å¦æœ‰breaking changes
        'schema_changes': True,  # æ•°æ®åº“schemaä¿®æ”¹
    }

    # å…³é”®è¯åŒ¹é…
    if any(kw in user_request for kw in triggers['keywords']):
        return True

    # å¤šæ–‡ä»¶æ“ä½œ
    estimated_files = estimate_affected_files(user_request, context)
    if estimated_files >= triggers['file_count']:
        return True

    # é£é™©è¯„ä¼°
    if contains_breaking_changes(user_request):
        return True

    return False
```

**æ‰‹åŠ¨è§¦å‘**ï¼š
ç”¨æˆ·ä¹Ÿå¯ä»¥æ˜¾å¼è¿›å…¥Plan Modeï¼š
```
ç”¨æˆ·: "è¿›å…¥Plan Modeï¼Œæˆ‘è¦é‡æ„æ•´ä¸ªè®¤è¯ç³»ç»Ÿ"
æˆ–
ç”¨æˆ·è¾“å…¥ /plan-mode
```

#### é˜¶æ®µ2ï¼šä¸Šä¸‹æ–‡æœé›†ï¼ˆContext Gatheringï¼‰
Plan Modeä¼šæ¯”æ™®é€šå¯¹è¯æ›´aggressiveåœ°æœé›†ä¸Šä¸‹æ–‡ï¼š
```python
async def gather_planning_context(task_description: str) -> Dict:
    """æœé›†è§„åˆ’æ‰€éœ€çš„æ‰€æœ‰ä¸Šä¸‹æ–‡"""
    context = {
        'files': [],
        'dependencies': [],
        'tests': [],
        'configs': [],
    }

    # 1. ä½¿ç”¨GlobæŸ¥æ‰¾ç›¸å…³æ–‡ä»¶
    patterns = extract_file_patterns(task_description)
    for pattern in patterns:
        files = await glob_search(pattern)
        context['files'].extend(files)

    # 2. ä½¿ç”¨Grepæœç´¢å…³é”®ä»£ç 
    keywords = extract_keywords(task_description)
    for keyword in keywords:
        matches = await grep_search(keyword, context_lines=3)
        context['dependencies'].extend(matches)

    # 3. è¯»å–å…³é”®æ–‡ä»¶
    for file in context['files'][:10]:  # é™åˆ¶æœ€å¤š10ä¸ªæ–‡ä»¶
        content = await read_file(file, max_lines=500)
        # åˆ†ææ–‡ä»¶ç»“æ„å’Œä¾èµ–å…³ç³»
        analyze_file_structure(content)

    # 4. è¯†åˆ«æµ‹è¯•æ–‡ä»¶
    test_files = await glob_search('test_*.py') + await glob_search('*_test.py')
    context['tests'] = test_files

    # 5. è¯»å–é…ç½®æ–‡ä»¶
    config_files = await glob_search('*.config.*') + await glob_search('.env*')
    context['configs'] = config_files

    return context
```

ğŸ“¸ **æˆªå›¾ä½ç½®**ï¼š[æ˜¾ç¤ºPlan Modeæœé›†ä¸Šä¸‹æ–‡æ—¶çš„è¿›åº¦æ¡å’Œæ—¥å¿—è¾“å‡º]

#### é˜¶æ®µ3ï¼šç”Ÿæˆè®¡åˆ’ï¼ˆPlan Generationï¼‰
Plan Modeä¼šç”Ÿæˆç»“æ„åŒ–çš„æ‰§è¡Œè®¡åˆ’ï¼š

**æ ‡å‡†Plan.mdæ ¼å¼**ï¼š
```markdown
# Execution Plan: è®¤è¯ç³»ç»Ÿé‡æ„

## Overview
- **Goal**: å°†åŸºäºSessionçš„è®¤è¯é‡æ„ä¸ºJWT Tokenè®¤è¯
- **Affected Files**: 12 files
- **Estimated Time**: 45 minutes
- **Risk Level**: Medium

## Pre-requisites
- [ ] Backup database
- [ ] Install `pyjwt` package
- [ ] Update environment variables

## Tasks
### Task 1: ä¿®æ”¹Useræ¨¡å‹
**File**: `models/user.py`
**Operation**: Edit
**Changes**:
- Remove `session_token` field
- Add `last_login` timestamp field
**Lines**: 45-78

### Task 2: å®ç°JWTå·¥å…·ç±»
**File**: `utils/jwt_handler.py`
**Operation**: Create
**Content**:
\`\`\`python
import jwt
from datetime import datetime, timedelta
from config import SECRET_KEY

class JWTHandler:
    @staticmethod
    def generate_token(user_id: int, expiry_hours: int = 24) -> str:
        payload = {
            'user_id': user_id,
            'exp': datetime.utcnow() + timedelta(hours=expiry_hours),
            'iat': datetime.utcnow()
        }
        return jwt.encode(payload, SECRET_KEY, algorithm='HS256')
\`\`\`

### Task 3: æ›´æ–°è®¤è¯ä¸­é—´ä»¶
**File**: `middleware/auth.py`
**Operation**: Edit
**Changes**:
- Replace session check with JWT validation
- Update error handling
**Lines**: 12-56

## Testing Strategy
1ã€Run unit tests: `pytest tests/auth/`
2ã€Manual testing: Login -> API call -> Verify token
3ã€Load testing: 100 concurrent requests

## Rollback Plan
If anything fails:
1ã€`git checkout .` to discard changes
2ã€Restore database from backup
3ã€Restart application

## Verification Checklist
- [ ] All tests pass
- [ ] No breaking changes to public API
- [ ] Performance not degraded (< 50ms per request)
- [ ] Documentation updated
```

**ç”Ÿæˆè®¡åˆ’çš„å®Œæ•´ä»£ç **ï¼š
```python
#!/usr/bin/env python3
"""
Plan Modeè®¡åˆ’ç”Ÿæˆå™¨
æ ¹æ®ç”¨æˆ·éœ€æ±‚å’Œä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆè¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’
"""
from typing import List, Dict, Any
from dataclasses import dataclass
from enum import Enum

class OperationType(Enum):
    """æ“ä½œç±»å‹æšä¸¾"""
    CREATE = "create"
    EDIT = "edit"
    DELETE = "delete"
    MOVE = "move"

@dataclass
class Task:
    """å•ä¸ªä»»åŠ¡çš„æ•°æ®ç»“æ„"""
    id: int
    title: str
    file_path: str
    operation: OperationType
    description: str
    changes: List[str]
    line_range: tuple = None  # (start, end)
    dependencies: List[int] = None  # ä¾èµ–çš„task id
    estimated_time_min: int = 5
    risk_level: str = "low"  # low, medium, high

@dataclass
class ExecutionPlan:
    """å®Œæ•´æ‰§è¡Œè®¡åˆ’"""
    goal: str
    affected_files: List[str]
    tasks: List[Task]
    prerequisites: List[str]
    testing_strategy: List[str]
    rollback_plan: List[str]
    verification_checklist: List[str]

class PlanGenerator:
    """è®¡åˆ’ç”Ÿæˆå™¨"""

    def __init__(self, context: Dict[str, Any]):
        self.context = context
        self.plan = None

    def generate(self, user_request: str) -> ExecutionPlan:
        """ç”Ÿæˆæ‰§è¡Œè®¡åˆ’"""
        # 1. åˆ†æç”¨æˆ·éœ€æ±‚
        goal = self._extract_goal(user_request)

        # 2. è¯†åˆ«å½±å“çš„æ–‡ä»¶
        affected_files = self._identify_affected_files(user_request)

        # 3. ç”Ÿæˆä»»åŠ¡åˆ—è¡¨
        tasks = self._generate_tasks(user_request, affected_files)

        # 4. å»ºç«‹ä»»åŠ¡ä¾èµ–å…³ç³»
        tasks = self._establish_dependencies(tasks)

        # 5. ç”Ÿæˆå‰ç½®æ¡ä»¶
        prerequisites = self._generate_prerequisites(tasks)

        # 6. ç”Ÿæˆæµ‹è¯•ç­–ç•¥
        testing_strategy = self._generate_testing_strategy(tasks)

        # 7. ç”Ÿæˆå›æ»šè®¡åˆ’
        rollback_plan = self._generate_rollback_plan(tasks)

        # 8. ç”ŸæˆéªŒæ”¶æ¸…å•
        verification_checklist = self._generate_verification_checklist(tasks)

        self.plan = ExecutionPlan(
            goal=goal,
            affected_files=affected_files,
            tasks=tasks,
            prerequisites=prerequisites,
            testing_strategy=testing_strategy,
            rollback_plan=rollback_plan,
            verification_checklist=verification_checklist
        )

        return self.plan

    def _extract_goal(self, user_request: str) -> str:
        """æå–æ ¸å¿ƒç›®æ ‡"""
        # ä½¿ç”¨NLPæˆ–è§„åˆ™æå–æ ¸å¿ƒåŠ¨ä½œå’Œç›®æ ‡
        keywords = ['é‡æ„', 'è¿ç§»', 'ä¼˜åŒ–', 'æ·»åŠ ', 'ä¿®å¤']
        for kw in keywords:
            if kw in user_request:
                return f"{kw}{user_request.split(kw)[1][:50]}"
        return user_request[:100]

    def _identify_affected_files(self, user_request: str) -> List[str]:
        """è¯†åˆ«å°†å—å½±å“çš„æ–‡ä»¶"""
        files = []

        # ä»ä¸Šä¸‹æ–‡ä¸­è·å–ç›¸å…³æ–‡ä»¶
        if 'files' in self.context:
            files.extend(self.context['files'])

        # æ ¹æ®éœ€æ±‚æ¨æ–­å¯èƒ½éœ€è¦çš„æ–°æ–‡ä»¶
        if 'æ·»åŠ ' in user_request or 'åˆ›å»º' in user_request:
            # æ¨æ–­éœ€è¦åˆ›å»ºçš„æ–‡ä»¶
            if 'API' in user_request:
                files.append('api/new_endpoint.py')
            if 'æµ‹è¯•' in user_request:
                files.append('tests/test_new_feature.py')

        return list(set(files))  # å»é‡

    def _generate_tasks(self, user_request: str, files: List[str]) -> List[Task]:
        """ç”Ÿæˆä»»åŠ¡åˆ—è¡¨"""
        tasks = []
        task_id = 1

        for file in files:
            # åˆ†ææ–‡ä»¶ç±»å‹å’Œæ“ä½œ
            if file.endswith('.py'):
                operation = self._determine_operation(file, user_request)

                task = Task(
                    id=task_id,
                    title=f"å¤„ç† {file}",
                    file_path=file,
                    operation=operation,
                    description=f"å¯¹ {file} æ‰§è¡Œ {operation.value} æ“ä½œ",
                    changes=[],
                    dependencies=[]
                )
                tasks.append(task)
                task_id += 1

        return tasks

    def _determine_operation(self, file: str, request: str) -> OperationType:
        """åˆ¤æ–­å¯¹æ–‡ä»¶çš„æ“ä½œç±»å‹"""
        if 'åˆ›å»º' in request or 'æ·»åŠ ' in request:
            return OperationType.CREATE
        elif 'åˆ é™¤' in request or 'ç§»é™¤' in request:
            return OperationType.DELETE
        elif 'ç§»åŠ¨' in request or 'é‡å‘½å' in request:
            return OperationType.MOVE
        else:
            return OperationType.EDIT

    def _establish_dependencies(self, tasks: List[Task]) -> List[Task]:
        """å»ºç«‹ä»»åŠ¡é—´çš„ä¾èµ–å…³ç³»"""
        # è§„åˆ™ï¼šCREATEæ“ä½œå¿…é¡»åœ¨EDITä¹‹å‰
        create_tasks = [t for t in tasks if t.operation == OperationType.CREATE]
        edit_tasks = [t for t in tasks if t.operation == OperationType.EDIT]

        for edit_task in edit_tasks:
            # å¦‚æœeditä»»åŠ¡ä¾èµ–createçš„æ–‡ä»¶
            for create_task in create_tasks:
                if create_task.file_path in edit_task.description:
                    if edit_task.dependencies is None:
                        edit_task.dependencies = []
                    edit_task.dependencies.append(create_task.id)

        return tasks

    def _generate_prerequisites(self, tasks: List[Task]) -> List[str]:
        """ç”Ÿæˆå‰ç½®æ¡ä»¶æ¸…å•"""
        prerequisites = ["å¤‡ä»½å½“å‰ä»£ç : `git stash` æˆ– `git commit`"]

        # æ£€æŸ¥æ˜¯å¦éœ€è¦å®‰è£…ä¾èµ–
        for task in tasks:
            if 'import' in task.description:
                prerequisites.append("å®‰è£…å¿…è¦çš„PythonåŒ…: `pip install -r requirements.txt`")
                break

        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ•°æ®åº“å¤‡ä»½
        db_related = any('database' in t.description.lower() or 'migration' in t.description.lower() for t in tasks)
        if db_related:
            prerequisites.append("å¤‡ä»½æ•°æ®åº“: `pg_dump mydb > backup.sql`")

        return prerequisites

    def _generate_testing_strategy(self, tasks: List[Task]) -> List[str]:
        """ç”Ÿæˆæµ‹è¯•ç­–ç•¥"""
        strategy = []

        # å•å…ƒæµ‹è¯•
        if any('test' in t.file_path for t in tasks):
            strategy.append("è¿è¡Œå•å…ƒæµ‹è¯•: `pytest tests/`")

        # é›†æˆæµ‹è¯•
        if len(tasks) > 5:
            strategy.append("è¿è¡Œé›†æˆæµ‹è¯•: `pytest tests/integration/`")

        # æ‰‹åŠ¨æµ‹è¯•
        strategy.append("æ‰‹åŠ¨æµ‹è¯•å…³é”®è·¯å¾„")

        return strategy

    def _generate_rollback_plan(self, tasks: List[Task]) -> List[str]:
        """ç”Ÿæˆå›æ»šè®¡åˆ’"""
        return [
            "å¦‚æœå‡ºç°é—®é¢˜ï¼Œç«‹å³æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š",
            "1. åœæ­¢åº”ç”¨: `docker-compose stop` æˆ– `systemctl stop app`",
            "2. å›æ»šä»£ç : `git reset --hard HEAD~1` æˆ– `git checkout <previous-commit>`",
            "3. æ¢å¤æ•°æ®åº“: `psql mydb < backup.sql`ï¼ˆå¦‚æœä¿®æ”¹äº†æ•°æ®åº“ï¼‰",
            "4. é‡å¯åº”ç”¨å¹¶éªŒè¯"
        ]

    def _generate_verification_checklist(self, tasks: List[Task]) -> List[str]:
        """ç”ŸæˆéªŒæ”¶æ¸…å•"""
        checklist = [
            "æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆ",
            "æ‰€æœ‰æµ‹è¯•é€šè¿‡",
            "æ— ç¼–è¯‘/è¯­æ³•é”™è¯¯",
        ]

        # æ ¹æ®ä»»åŠ¡ç±»å‹æ·»åŠ ç‰¹å®šæ£€æŸ¥é¡¹
        if any(t.operation == OperationType.CREATE for t in tasks):
            checklist.append("æ–°æ–‡ä»¶å·²æ·»åŠ åˆ°ç‰ˆæœ¬æ§åˆ¶")

        if any('api' in t.file_path.lower() for t in tasks):
            checklist.append("APIæ–‡æ¡£å·²æ›´æ–°")

        return checklist

    def to_markdown(self) -> str:
        """å°†è®¡åˆ’è½¬æ¢ä¸ºMarkdownæ ¼å¼"""
        if not self.plan:
            return ""

        md = f"# Execution Plan: {self.plan.goal}\n\n"

        md += "## Overview\n"
        md += f"- **Affected Files**: {len(self.plan.affected_files)} files\n"
        md += f"- **Total Tasks**: {len(self.plan.tasks)}\n\n"

        md += "## Pre-requisites\n"
        for prereq in self.plan.prerequisites:
            md += f"- [ ] {prereq}\n"
        md += "\n"

        md += "## Tasks\n\n"
        for task in self.plan.tasks:
            md += f"### Task {task.id}: {task.title}\n"
            md += f"**File**: `{task.file_path}`\n"
            md += f"**Operation**: {task.operation.value}\n"
            md += f"**Description**: {task.description}\n"
            if task.dependencies:
                md += f"**Depends on**: Tasks {', '.join(map(str, task.dependencies))}\n"
            md += "\n"

        md += "## Testing Strategy\n"
        for i, test in enumerate(self.plan.testing_strategy, 1):
            md += f"{i}. {test}\n"
        md += "\n"

        md += "## Rollback Plan\n"
        for step in self.plan.rollback_plan:
            md += f"{step}\n"
        md += "\n"

        md += "## Verification Checklist\n"
        for item in self.plan.verification_checklist:
            md += f"- [ ] {item}\n"

        return md

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    context = {
        'files': ['models/user.py', 'api/auth.py', 'middleware/session.py'],
        'dependencies': []
    }

    generator = PlanGenerator(context)
    plan = generator.generate("é‡æ„è®¤è¯ç³»ç»Ÿï¼Œä»Sessionæ”¹ä¸ºJWT")

    print(generator.to_markdown())
```

ğŸ“¸ **æˆªå›¾ä½ç½®**ï¼š[æ˜¾ç¤ºç”Ÿæˆçš„Plan.mdæ–‡ä»¶åœ¨VS Codeä¸­çš„å®Œæ•´æ¸²æŸ“æ•ˆæœ]

#### é˜¶æ®µ4ï¼šç”¨æˆ·å®¡æ‰¹ï¼ˆUser Approvalï¼‰
Planç”Ÿæˆåï¼ŒClaudeä¼šç­‰å¾…ç”¨æˆ·çš„åé¦ˆï¼š

**ä¸‰ç§å“åº”**ï¼š
1ã€**Approveï¼ˆæ‰¹å‡†ï¼‰**ï¼š"çœ‹èµ·æ¥ä¸é”™ï¼Œæ‰§è¡Œå§" æˆ– "OK" æˆ– "æ‰¹å‡†"
2ã€**Rejectï¼ˆæ‹’ç»ï¼‰**ï¼š"ä¸è¡Œï¼Œè¿™ä¸ªæ–¹æ¡ˆæœ‰é—®é¢˜" æˆ– "å–æ¶ˆ"
3ã€**Modifyï¼ˆä¿®æ”¹ï¼‰**ï¼š"Task 3æ”¹æˆXXX" æˆ– "è·³è¿‡Task 5"

**ä¿®æ”¹è®¡åˆ’çš„ç¤ºä¾‹å¯¹è¯**ï¼š
```
Claude: [å±•ç¤ºPlan.md]
ç”¨æˆ·: "Task 2çš„JWTè¿‡æœŸæ—¶é—´æ”¹æˆ48å°æ—¶ï¼ŒTask 5ä¸éœ€è¦"
Claude: [æ›´æ–°è®¡åˆ’] å·²ä¿®æ”¹ï¼š
       - Task 2: expiry_hours = 48
       - Task 5: å·²ç§»é™¤
       è¯·ç¡®è®¤ä¿®æ”¹åçš„è®¡åˆ’ï¼Ÿ
ç”¨æˆ·: "OKï¼Œæ‰§è¡Œ"
Claude: [å¼€å§‹æ‰§è¡Œ]
```

#### é˜¶æ®µ5ï¼šæ‰§è¡Œè®¡åˆ’ï¼ˆExecutionï¼‰
æ‰¹å‡†åï¼ŒClaudeæŒ‰é¡ºåºæ‰§è¡Œè®¡åˆ’ä¸­çš„ä»»åŠ¡ï¼š
```python
async def execute_plan(plan: ExecutionPlan) -> Dict[str, Any]:
    """æ‰§è¡Œè®¡åˆ’ä¸­çš„æ‰€æœ‰ä»»åŠ¡"""
    results = {
        'completed': [],
        'failed': [],
        'skipped': []
    }

    # æŒ‰ä¾èµ–é¡ºåºæ’åºä»»åŠ¡
    sorted_tasks = topological_sort(plan.tasks)

    for task in sorted_tasks:
        print(f"ğŸš€ Executing Task {task.id}: {task.title}")

        try:
            # æ£€æŸ¥ä¾èµ–æ˜¯å¦å®Œæˆ
            if task.dependencies:
                for dep_id in task.dependencies:
                    if dep_id not in [t.id for t in results['completed']]:
                        print(f"â¸ï¸  Skipping Task {task.id}: Dependency {dep_id} not met")
                        results['skipped'].append(task)
                        continue

            # æ‰§è¡Œä»»åŠ¡
            if task.operation == OperationType.CREATE:
                success = await create_file(task.file_path, task.content)
            elif task.operation == OperationType.EDIT:
                success = await edit_file(task.file_path, task.changes)
            elif task.operation == OperationType.DELETE:
                success = await delete_file(task.file_path)
            elif task.operation == OperationType.MOVE:
                success = await move_file(task.file_path, task.new_path)

            if success:
                print(f"âœ… Task {task.id} completed")
                results['completed'].append(task)
            else:
                print(f"âŒ Task {task.id} failed")
                results['failed'].append(task)

        except Exception as e:
            print(f"âŒ Task {task.id} error: {str(e)}")
            results['failed'].append(task)

    return results

def topological_sort(tasks: List[Task]) -> List[Task]:
    """æ ¹æ®ä¾èµ–å…³ç³»å¯¹ä»»åŠ¡è¿›è¡Œæ‹“æ‰‘æ’åº"""
    from collections import deque, defaultdict

    # æ„å»ºé‚»æ¥è¡¨å’Œå…¥åº¦è¡¨
    graph = defaultdict(list)
    in_degree = {task.id: 0 for task in tasks}

    for task in tasks:
        if task.dependencies:
            for dep_id in task.dependencies:
                graph[dep_id].append(task.id)
                in_degree[task.id] += 1

    # BFSæ‹“æ‰‘æ’åº
    queue = deque([tid for tid, degree in in_degree.items() if degree == 0])
    sorted_ids = []

    while queue:
        current_id = queue.popleft()
        sorted_ids.append(current_id)

        for neighbor_id in graph[current_id]:
            in_degree[neighbor_id] -= 1
            if in_degree[neighbor_id] == 0:
                queue.append(neighbor_id)

    # æŒ‰æ’åºåçš„IDé¡ºåºè¿”å›ä»»åŠ¡
    id_to_task = {task.id: task for task in tasks}
    return [id_to_task[tid] for tid in sorted_ids]
```

**æ‰§è¡Œè¿‡ç¨‹çš„è¿›åº¦æ˜¾ç¤º**ï¼š
```
ğŸš€ Executing Task 1: ä¿®æ”¹Useræ¨¡å‹
   ğŸ“ Editing models/user.py (lines 45-78)
   âœ… Task 1 completed

ğŸš€ Executing Task 2: å®ç°JWTå·¥å…·ç±»
   ğŸ“ Creating utils/jwt_handler.py
   âœ… Task 2 completed

ğŸš€ Executing Task 3: æ›´æ–°è®¤è¯ä¸­é—´ä»¶
   ğŸ“ Editing middleware/auth.py (lines 12-56)
   âš ï¸  Warning: Unused import detected
   âœ… Task 3 completed (with warnings)

Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% (3/3 tasks)
```

#### é˜¶æ®µ6ï¼šéªŒè¯ç»“æœï¼ˆVerificationï¼‰
æ‰§è¡Œå®Œæˆåï¼ŒPlan Modeä¼šè‡ªåŠ¨è¿è¡ŒéªŒè¯ï¼š
```python
async def verify_execution(plan: ExecutionPlan, results: Dict) -> bool:
    """éªŒè¯æ‰§è¡Œç»“æœ"""
    print("\nğŸ” å¼€å§‹éªŒè¯æ‰§è¡Œç»“æœ...\n")

    verification_results = []

    # 1. æ£€æŸ¥æ‰€æœ‰ä»»åŠ¡æ˜¯å¦å®Œæˆ
    if len(results['failed']) > 0:
        print(f"âŒ {len(results['failed'])} ä¸ªä»»åŠ¡å¤±è´¥")
        verification_results.append(False)
    else:
        print("âœ… æ‰€æœ‰ä»»åŠ¡æˆåŠŸå®Œæˆ")
        verification_results.append(True)

    # 2. è¿è¡Œæµ‹è¯•
    if plan.testing_strategy:
        print("\nğŸ§ª è¿è¡Œæµ‹è¯•...")
        for test_cmd in plan.testing_strategy:
            result = await run_command(test_cmd)
            if result.returncode == 0:
                print(f"âœ… {test_cmd} - PASSED")
                verification_results.append(True)
            else:
                print(f"âŒ {test_cmd} - FAILED")
                print(f"   Error: {result.stderr}")
                verification_results.append(False)

    # 3. æ£€æŸ¥è¯­æ³•é”™è¯¯
    print("\nğŸ” æ£€æŸ¥è¯­æ³•é”™è¯¯...")
    python_files = [t.file_path for t in results['completed'] if t.file_path.endswith('.py')]
    for file in python_files:
        result = await run_command(f"python -m py_compile {file}")
        if result.returncode == 0:
            print(f"âœ… {file} - æ— è¯­æ³•é”™è¯¯")
            verification_results.append(True)
        else:
            print(f"âŒ {file} - è¯­æ³•é”™è¯¯")
            verification_results.append(False)

    # 4. éªŒæ”¶æ¸…å•æ£€æŸ¥
    print("\nğŸ“‹ éªŒæ”¶æ¸…å•:")
    for item in plan.verification_checklist:
        # è‡ªåŠ¨åŒ–æ£€æŸ¥éƒ¨åˆ†æ¸…å•é¡¹
        if "æµ‹è¯•é€šè¿‡" in item:
            status = "âœ…" if all(verification_results) else "âŒ"
        elif "æ— é”™è¯¯" in item:
            status = "âœ…"  # å·²åœ¨ä¸Šé¢æ£€æŸ¥
        else:
            # éœ€è¦äººå·¥ç¡®è®¤çš„é¡¹
            status = "â¸ï¸  å¾…ç¡®è®¤"
        print(f"{status} {item}")

    # æ€»ä½“åˆ¤æ–­
    all_passed = all(verification_results)

    if all_passed:
        print("\nğŸ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼")
    else:
        print("\nâš ï¸  å­˜åœ¨éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥")

    return all_passed
```

#### é˜¶æ®µ7ï¼šé€€å‡ºä¸æ€»ç»“ï¼ˆExit & Summaryï¼‰
æœ€åï¼ŒPlan Modeç”Ÿæˆæ‰§è¡Œæ€»ç»“å¹¶é€€å‡ºï¼š
```
=================================================
       Plan Mode æ‰§è¡Œæ€»ç»“
=================================================

ğŸ“Š ä»»åŠ¡ç»Ÿè®¡:
  - æ€»ä»»åŠ¡æ•°: 5
  - æˆåŠŸ: 4
  - å¤±è´¥: 1
  - è·³è¿‡: 0

ğŸ“ ä¿®æ”¹æ–‡ä»¶:
  - models/user.py (ç¼–è¾‘: 33è¡Œ)
  - utils/jwt_handler.py (æ–°å»º: 45è¡Œ)
  - middleware/auth.py (ç¼–è¾‘: 44è¡Œ)
  - tests/test_auth.py (ç¼–è¾‘: 12è¡Œ)

âš ï¸  è­¦å‘Šä¿¡æ¯:
  - middleware/auth.py:15 - Unused import 'session'

ğŸ§ª æµ‹è¯•ç»“æœ:
  âœ… å•å…ƒæµ‹è¯•: 15/15 passed
  âœ… é›†æˆæµ‹è¯•: 3/3 passed

â±ï¸  æ€»ç”¨æ—¶: 8åˆ†32ç§’

ğŸ¯ å»ºè®®åç»­æ“ä½œ:
  1. Reviewä»£ç å˜æ›´: git diff
  2. æäº¤ä»£ç : git add . && git commit -m "refactor: migrate to JWT auth"
  3. éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒéªŒè¯

=================================================
```

### 2.3 Plan Modeä¸æ™®é€šå¯¹è¯çš„æ ¸å¿ƒå·®å¼‚
**ä¸Šä¸‹æ–‡æœé›†ç­–ç•¥ä¸åŒ**ï¼š


**æ–¹é¢**ï¼šGlobæœç´¢
**æ™®é€šå¯¹è¯**ï¼šæŒ‰éœ€æœç´¢
**Plan Mode**ï¼šä¸»åŠ¨æœç´¢æ‰€æœ‰ç›¸å…³æ–‡ä»¶


**æ–¹é¢**ï¼šGrepæœç´¢
**æ™®é€šå¯¹è¯**ï¼šå•å…³é”®è¯
**Plan Mode**ï¼šå¤šå…³é”®è¯+ä¸Šä¸‹æ–‡


**æ–¹é¢**ï¼šReadæ–‡ä»¶æ•°
**æ™®é€šå¯¹è¯**ï¼š1-3ä¸ª
**Plan Mode**ï¼š5-15ä¸ª


**æ–¹é¢**ï¼šåˆ†ææ·±åº¦
**æ™®é€šå¯¹è¯**ï¼šæµ…å±‚
**Plan Mode**ï¼šæ·±åº¦ä¾èµ–åˆ†æ


**å†³ç­–è¿‡ç¨‹ä¸åŒ**ï¼š
```
æ™®é€šå¯¹è¯:
ç”¨æˆ·è¯·æ±‚ -> ç«‹å³æ‰§è¡Œ -> è¿”å›ç»“æœ

Plan Mode:
ç”¨æˆ·è¯·æ±‚ -> æœé›†ä¸Šä¸‹æ–‡ -> ç”Ÿæˆè®¡åˆ’ -> ç­‰å¾…å®¡æ‰¹ -> æ‰§è¡Œ -> éªŒè¯
```

**é”™è¯¯å¤„ç†ä¸åŒ**ï¼š

æ™®é€šå¯¹è¯ï¼šå‡ºé”™åç”¨æˆ·æ‰‹åŠ¨é‡è¯•
Plan Modeï¼šè®¡åˆ’å†…åŒ…å«rollbackç­–ç•¥ï¼Œå¯è‡ªåŠ¨æ¢å¤

### 2.4 Plan Mode Orchestratorå®Œæ•´å®ç°
ç°åœ¨æˆ‘ä»¬å®ç°ä¸€ä¸ªå®Œæ•´çš„Plan Modeåè°ƒå™¨ï¼š
```python
#!/usr/bin/env python3
"""
Plan Mode Orchestrator - å®Œæ•´å®ç°
åè°ƒPlan Modeçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ
"""
import json
import asyncio
from typing import Dict, Any, List, Optional
from enum import Enum
from dataclasses import dataclass, asdict
from pathlib import Path

class PlanModeState(Enum):
    """Plan ModeçŠ¶æ€æšä¸¾"""
    IDLE = "idle"
    GATHERING_CONTEXT = "gathering_context"
    GENERATING_PLAN = "generating_plan"
    AWAITING_APPROVAL = "awaiting_approval"
    EXECUTING = "executing"
    VERIFYING = "verifying"
    COMPLETED = "completed"
    FAILED = "failed"

@dataclass
class PlanModeSession:
    """Plan Modeä¼šè¯æ•°æ®"""
    session_id: str
    state: PlanModeState
    user_request: str
    context: Dict[str, Any]
    plan: Optional['ExecutionPlan'] = None
    execution_results: Optional[Dict] = None
    started_at: str = ""
    completed_at: str = ""

class PlanModeOrchestrator:
    """Plan Modeåè°ƒå™¨ - ç®¡ç†æ•´ä¸ªæµç¨‹"""

    def __init__(self, session_dir: str = ".claude/plan-mode-sessions"):
        self.session_dir = Path(session_dir)
        self.session_dir.mkdir(parents=True, exist_ok=True)
        self.current_session: Optional[PlanModeSession] = None
        self.plan_generator = PlanGenerator({})

    async def enter_plan_mode(self, user_request: str) -> str:
        """è¿›å…¥Plan Mode"""
        from datetime import datetime

        # åˆ›å»ºæ–°ä¼šè¯
        session_id = datetime.now().strftime("%Y%m%d_%H%M%S")
        self.current_session = PlanModeSession(
            session_id=session_id,
            state=PlanModeState.IDLE,
            user_request=user_request,
            context={},
            started_at=datetime.now().isoformat()
        )

        print(f"ğŸš€ è¿›å…¥Plan Mode (Session: {session_id})")
        print(f"ğŸ“‹ ä»»åŠ¡: {user_request}\n")

        # æ‰§è¡Œå®Œæ•´æµç¨‹
        await self._transition_to(PlanModeState.GATHERING_CONTEXT)
        await self._gather_context()

        await self._transition_to(PlanModeState.GENERATING_PLAN)
        plan_md = await self._generate_plan()

        await self._transition_to(PlanModeState.AWAITING_APPROVAL)

        return plan_md

    async def _transition_to(self, new_state: PlanModeState):
        """çŠ¶æ€è½¬æ¢"""
        old_state = self.current_session.state
        self.current_session.state = new_state
        print(f"ğŸ”„ çŠ¶æ€è½¬æ¢: {old_state.value} -> {new_state.value}")

        # ä¿å­˜ä¼šè¯çŠ¶æ€
        self._save_session()

    async def _gather_context(self):
        """æœé›†ä¸Šä¸‹æ–‡"""
        print("ğŸ“š å¼€å§‹æœé›†ä¸Šä¸‹æ–‡...")

        # å®é™…å®ç°ä¸­ä¼šè°ƒç”¨Glob/Grep/Readå·¥å…·
        # è¿™é‡Œç®€åŒ–ä¸ºæ¨¡æ‹Ÿ
        self.current_session.context = {
            'files': ['models/user.py', 'api/auth.py'],
            'dependencies': ['flask', 'pyjwt'],
            'tests': ['tests/test_auth.py']
        }

        print(f"âœ… ä¸Šä¸‹æ–‡æœé›†å®Œæˆ:")
        print(f"   - æ–‡ä»¶: {len(self.current_session.context['files'])}")
        print(f"   - ä¾èµ–: {len(self.current_session.context['dependencies'])}")
        print(f"   - æµ‹è¯•: {len(self.current_session.context['tests'])}\n")

    async def _generate_plan(self) -> str:
        """ç”Ÿæˆæ‰§è¡Œè®¡åˆ’"""
        print("ğŸ§  ç”Ÿæˆæ‰§è¡Œè®¡åˆ’...\n")

        self.plan_generator.context = self.current_session.context
        plan = self.plan_generator.generate(self.current_session.user_request)
        self.current_session.plan = plan

        plan_md = self.plan_generator.to_markdown()

        # ä¿å­˜è®¡åˆ’åˆ°æ–‡ä»¶
        plan_file = self.session_dir / f"{self.current_session.session_id}_plan.md"
        plan_file.write_text(plan_md, encoding='utf-8')

        print(f"âœ… æ‰§è¡Œè®¡åˆ’å·²ç”Ÿæˆ")
        print(f"ğŸ“„ è®¡åˆ’æ–‡ä»¶: {plan_file}\n")
        print("=" * 60)
        print(plan_md)
        print("=" * 60)

        return plan_md

    async def approve_and_execute(self) -> Dict:
        """ç”¨æˆ·æ‰¹å‡†åæ‰§è¡Œè®¡åˆ’"""
        if self.current_session.state != PlanModeState.AWAITING_APPROVAL:
            raise ValueError("å½“å‰çŠ¶æ€ä¸å…è®¸æ‰§è¡Œ")

        print("\nâœ… ç”¨æˆ·å·²æ‰¹å‡†ï¼Œå¼€å§‹æ‰§è¡Œè®¡åˆ’...\n")

        await self._transition_to(PlanModeState.EXECUTING)
        results = await execute_plan(self.current_session.plan)
        self.current_session.execution_results = results

        await self._transition_to(PlanModeState.VERIFYING)
        verification_passed = await verify_execution(
            self.current_session.plan,
            results
        )

        if verification_passed:
            await self._transition_to(PlanModeState.COMPLETED)
        else:
            await self._transition_to(PlanModeState.FAILED)

        return results

    async def modify_plan(self, modifications: str):
        """ä¿®æ”¹è®¡åˆ’"""
        print(f"âœï¸  ä¿®æ”¹è®¡åˆ’: {modifications}")

        # è§£æä¿®æ”¹æŒ‡ä»¤å¹¶æ›´æ–°è®¡åˆ’
        # ç®€åŒ–å®ç°ï¼šå®é™…éœ€è¦NLPè§£æ
        if "åˆ é™¤Task" in modifications:
            task_id = int(modifications.split("Task")[1].strip())
            self.current_session.plan.tasks = [
                t for t in self.current_session.plan.tasks if t.id != task_id
            ]
            print(f"âœ… å·²åˆ é™¤Task {task_id}")

        # é‡æ–°ç”ŸæˆMarkdown
        plan_md = self.plan_generator.to_markdown()
        print("\næ›´æ–°åçš„è®¡åˆ’:\n")
        print(plan_md)

    async def reject_plan(self, reason: str):
        """æ‹’ç»è®¡åˆ’"""
        print(f"âŒ ç”¨æˆ·æ‹’ç»è®¡åˆ’: {reason}")
        await self._transition_to(PlanModeState.FAILED)

    async def exit_plan_mode(self) -> str:
        """é€€å‡ºPlan Modeå¹¶ç”Ÿæˆæ€»ç»“"""
        from datetime import datetime

        self.current_session.completed_at = datetime.now().isoformat()

        summary = self._generate_summary()
        print(summary)

        # æœ€ç»ˆä¿å­˜ä¼šè¯
        self._save_session()

        return summary

    def _generate_summary(self) -> str:
        """ç”Ÿæˆæ‰§è¡Œæ€»ç»“"""
        if not self.current_session.execution_results:
            return "âŒ Plan Modeå¼‚å¸¸é€€å‡ºï¼Œæœªæ‰§è¡Œä»»åŠ¡"

        results = self.current_session.execution_results
        total = len(self.current_session.plan.tasks)
        completed = len(results['completed'])
        failed = len(results['failed'])

        summary = f"""
{'=' * 60}
         Plan Mode æ‰§è¡Œæ€»ç»“
{'=' * 60}

ğŸ“Š ä»»åŠ¡ç»Ÿè®¡:
  - æ€»ä»»åŠ¡æ•°: {total}
  - æˆåŠŸ: {completed}
  - å¤±è´¥: {failed}
  - æˆåŠŸç‡: {completed/total*100:.1f}%

ğŸ“ ä¿®æ”¹æ–‡ä»¶:
"""

        for task in results['completed']:
            summary += f"  - {task.file_path} ({task.operation.value})\n"

        if failed > 0:
            summary += f"\nâŒ å¤±è´¥ä»»åŠ¡:\n"
            for task in results['failed']:
                summary += f"  - Task {task.id}: {task.title}\n"

        summary += f"""
{'=' * 60}
"""
        return summary

    def _save_session(self):
        """ä¿å­˜ä¼šè¯çŠ¶æ€"""
        session_file = self.session_dir / f"{self.current_session.session_id}.json"

        # å°†dataclassè½¬æ¢ä¸ºdict
        session_dict = asdict(self.current_session)
        # å¤„ç†Enum
        session_dict['state'] = session_dict['state'].value if hasattr(session_dict['state'], 'value') else session_dict['state']

        session_file.write_text(json.dumps(session_dict, indent=2, ensure_ascii=False), encoding='utf-8')

    def load_session(self, session_id: str):
        """åŠ è½½å·²æœ‰ä¼šè¯"""
        session_file = self.session_dir / f"{session_id}.json"
        if not session_file.exists():
            raise FileNotFoundError(f"Session {session_id} not found")

        session_dict = json.loads(session_file.read_text(encoding='utf-8'))
        # æ¢å¤ä¼šè¯ï¼ˆç®€åŒ–å®ç°ï¼‰
        print(f"âœ… å·²åŠ è½½Session: {session_id}")

# ä½¿ç”¨ç¤ºä¾‹
async def main():
    orchestrator = PlanModeOrchestrator()

    # 1. è¿›å…¥Plan Mode
    plan_md = await orchestrator.enter_plan_mode(
        "é‡æ„è®¤è¯ç³»ç»Ÿï¼Œä»Sessionæ”¹ä¸ºJWT"
    )

    # 2. ç”¨æˆ·å®¡æ‰¹ï¼ˆæ¨¡æ‹Ÿï¼‰
    print("\n[ç­‰å¾…ç”¨æˆ·å®¡æ‰¹...]")
    await asyncio.sleep(1)  # æ¨¡æ‹Ÿç”¨æˆ·æ€è€ƒ

    # 3. æ‰§è¡Œè®¡åˆ’
    results = await orchestrator.approve_and_execute()

    # 4. é€€å‡ºå¹¶ç”Ÿæˆæ€»ç»“
    summary = await orchestrator.exit_plan_mode()

if __name__ == "__main__":
    asyncio.run(main())
```

ğŸ“¸ **æˆªå›¾ä½ç½®**ï¼š[æ˜¾ç¤ºPlan Mode Orchestratorè¿è¡Œæ—¶çš„å®Œæ•´æ—¥å¿—è¾“å‡ºï¼ŒåŒ…å«çŠ¶æ€è½¬æ¢å’Œè¿›åº¦ä¿¡æ¯]


*(ç”±äºå­—æ•°é™åˆ¶ï¼Œæœ¬æ–‡æ¡£æœªå®Œå¾…ç»­ã€‚æ¥ä¸‹æ¥çš„ç« èŠ‚å°†åŒ…æ‹¬ï¼š)*

- **ç¬¬ä¸‰ç« ï¼šMulti-Agentåä½œæ¨¡å¼**ï¼ˆ3000å­—ï¼‰
- **ç¬¬å››ç« ï¼šMulti-turn Conversationæœ€ä½³å®è·µ**ï¼ˆ1500å­—ï¼‰
- **ç¬¬äº”ç« ï¼šå·¥ä½œæµè‡ªåŠ¨åŒ–è„šæœ¬**ï¼ˆ1500å­—ï¼‰

**å½“å‰å­—æ•°ï¼šçº¦10,500å­—**


## ğŸ“š ç›¸å…³æ–‡æ¡£
- [Commandsç³»ç»Ÿå®Œæ•´æ–‡æ¡£](../03-Commandsç³»ç»Ÿ/Commandsç³»ç»Ÿå®Œæ•´æ–‡æ¡£.md)
- [Skillsç³»ç»Ÿæ¶æ„è§£æ](../06-Skillså®šåˆ¶/Skillsç³»ç»Ÿæ¶æ„è§£æ.md)
- [ä¼ä¸šå›¢é˜Ÿåä½œæœ€ä½³å®è·µ](../08-ä¼ä¸šå®æˆ˜/ä¼ä¸šå›¢é˜Ÿåä½œæœ€ä½³å®è·µ.md)

## ğŸ”— å¤–éƒ¨èµ„æº
- [Claude Codeå®˜æ–¹æ–‡æ¡£](https://docs.anthropic.com/claude-code)
- [Plan Modeæœ€ä½³å®è·µæŒ‡å—](https://github.com/anthropics/claude-code/wiki/plan-mode)
- [Multi-Agentæ¶æ„æ¨¡å¼](https://github.com/anthropics/claude-code/examples/multi-agent)
