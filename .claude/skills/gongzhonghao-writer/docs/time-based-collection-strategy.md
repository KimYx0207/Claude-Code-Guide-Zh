# 基于时间的增量收集策略

## 问题分析

### 核心问题
用户发现的关键问题：**旧文章的数据会持续增长**

```
第1天收集:  文章A (阅读500, 点赞10)
第2天收集:  文章A (阅读800, 点赞15)  ← 数据增长了！
第3天收集:  文章A (阅读1200, 点赞20) ← 继续增长
```

**单纯用标题去重的问题**：
- ❌ 无法区分"新文章"和"数据更新"
- ❌ 旧文章的最新数据会被丢弃
- ❌ 数据永远停留在首次收集时的状态

### 时间格式问题

微信使用相对时间：
- "今天 17:29" - 明天就变成"昨天"
- "星期五 19:00" - 下周五会产生歧义
- "11月29日 18:30" - 没有年份信息

**解决方案**：`time_utils.py` 模块转换为绝对时间

## 收集策略设计

### 策略1：按天数收集（推荐）

**命令**：
```bash
python collect_incremental.py --days=7
```

**逻辑**：
1. 只收集最近N天发布的文章
2. 遇到N天前的文章，立即停止
3. 对于已存在的文章，更新数据

**适用场景**：
- 每日/每周定期收集
- 追踪最近文章的数据变化

### 策略2：按日期范围收集

**命令**：
```bash
python collect_incremental.py --since="2025-11-25"
python collect_incremental.py --from="2025-11-25" --to="2025-11-30"
```

**逻辑**：
1. 只收集指定日期范围的文章
2. 超出范围立即停止

**适用场景**：
- 回填历史数据
- 特定时间段分析

### 策略3：全量更新模式

**命令**：
```bash
python collect_incremental.py --full-update
```

**逻辑**：
1. 收集所有页面
2. 更新所有已存在文章的数据
3. 添加新文章

**适用场景**：
- 长时间未收集（>7天）
- 需要更新所有文章的最新数据

## 数据更新逻辑

### 新逻辑流程

```
收集到文章 A
    |
    v
检查标题是否存在？
    |
    +-- 否 --> 判断发布时间是否在范围内？
    |           |
    |           +-- 是 --> 添加新文章
    |           |
    |           +-- 否 --> 停止收集（超出时间范围）
    |
    +-- 是 --> 判断发布时间是否在范围内？
                |
                +-- 是 --> 更新文章数据（阅读/点赞/在看）
                |
                +-- 否 --> 跳过（旧文章不在范围内）
```

### 代码示例

```python
from time_utils import is_within_days, parse_wechat_time

# 检查文章是否在最近7天内
if is_within_days(article['publish_time'], days=7):
    if title in existing_titles:
        # 更新现有文章数据
        update_article_data(article)
    else:
        # 添加新文章
        new_articles.append(article)
else:
    # 超出时间范围，停止收集
    break
```

## 数据结构改进

### 当前结构
```json
{
  "publish_time": "今天 17:29",
  "title": "文章标题",
  "read_count": 673,
  ...
}
```

**问题**：`publish_time` 是相对时间，每天都在变化

### 建议结构
```json
{
  "publish_time": "今天 17:29",
  "publish_date": "2025-12-01 17:29",  // 新增：绝对时间
  "title": "文章标题",
  "read_count": 673,
  "last_updated": "2025-12-01 10:00",  // 新增：最后更新时间
  ...
}
```

**优势**：
- ✅ 精确知道文章发布日期
- ✅ 追踪数据更新时间
- ✅ 支持时间范围查询

## 使用场景示例

### 场景1：每日定期收集（推荐）

```bash
# 每天早上收集昨天的新文章 + 最近7天文章的数据更新
python collect_incremental.py --days=7
```

**预期结果**：
- 新增：昨天发布的文章
- 更新：最近7天文章的阅读/点赞/在看数据
- 停止：遇到8天前的文章

### 场景2：周末批量收集

```bash
# 每周日收集本周所有文章
python collect_incremental.py --days=7
```

### 场景3：长时间未收集

```bash
# 收集最近30天的所有文章（全量更新）
python collect_incremental.py --days=30
```

或

```bash
# 全量更新模式（收集所有页面）
python collect_incremental.py --full-update
```

### 场景4：历史数据回填

```bash
# 回填11月份的数据
python collect_incremental.py --from="2025-11-01" --to="2025-11-30"
```

## 报告改进

### 当前报告
```
[增量统计]
- 新增文章：5篇
- 跳过文章：1篇（重复）
```

### 改进后报告
```
[增量统计]
- 收集范围：最近7天（2025-11-25 ~ 2025-12-01）
- 新增文章：2篇
- 更新文章：3篇（数据刷新）
- 跳过文章：5篇（超出范围）

[数据变化]
- 总阅读增长：+2,345
- 总点赞增长：+56
- 总在看增长：+123

[更新详情]
1、文章A：阅读 500→800 (+300), 点赞 10→15 (+5)
2、文章B：阅读 1200→1500 (+300), 点赞 20→25 (+5)
```

## 实现优先级

1. **高优先级（立即实现）**：
   - [x] 时间解析工具 (`time_utils.py`)
   - [ ] `--days=N` 参数支持
   - [ ] 数据更新逻辑（更新已存在文章）

2. **中优先级（本周完成）**：
   - [ ] 添加 `publish_date` 和 `last_updated` 字段
   - [ ] 改进报告格式（显示数据变化）

3. **低优先级（未来改进）**：
   - [ ] `--from/--to` 日期范围参数
   - [ ] `--full-update` 全量更新模式
   - [ ] 数据变化趋势图

## 命令参数设计

```bash
# 基础命令
python collect_incremental.py

# 指定天数（推荐）
python collect_incremental.py --days=7

# 指定日期
python collect_incremental.py --since="2025-11-25"

# 日期范围
python collect_incremental.py --from="2025-11-25" --to="2025-11-30"

# 全量更新
python collect_incremental.py --full-update

# 调试模式（显示详细日志）
python collect_incremental.py --days=7 --verbose
```

## 总结

**关键改进**：
1. ✅ 时间解析：相对时间 → 绝对时间
2. ⏳ 时间过滤：只收集指定范围的文章
3. ⏳ 数据更新：更新已存在文章的最新数据
4. ⏳ 报告改进：显示数据变化和更新详情

**用户价值**：
- 每天快速收集新文章 + 更新热门文章数据
- 清楚看到文章数据的增长趋势
- 灵活控制收集范围，避免浪费时间
